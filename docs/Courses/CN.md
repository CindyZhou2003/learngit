# 计算机网络 Computer Network

> [!WARNING]
>
> ➢平时成绩50% = 课程作业 7-8次 + 课程实验 6次 + 出勤+quiz 3-4 次
> ➢ 期末考试50% (闭卷) 试卷为英文

> [!TIP]
>
> <https://zjucomp.net/docs/terms> 术语中英对照表

[TOC]

## 引言

### 初识互联网

网络的基本功能：传递信息

服务用什么区分？

- 功能、延迟、带宽、丢失率
- 端节点数目、服务接口
- 可靠性、实时/非实时等外特性

### 网络实例

计算机网络拓扑结构主要取决于它的通信子网

#### 网络分类（按地域规模）

- 个域网PAN（ Personal Area Network ）：能在便携式消费电器与通信设备之间进行短距离通信的网络；覆盖范围一般在10米半径以内，如蓝牙耳机等
- 局域网LAN（Local Area Network）：局部地区形成的区域网络，如企业网络；分布地区范围有限，可大可小，大到一栋建筑、小到办公室内的组网；电脑WLAN接入，打印机共享等等
- 城域网MAN（Metropolitan Area Network ）：范围覆盖一个城市的网络
- 广域网WAN（Wide Area Network）：覆盖很大地理区域，乃至覆盖地区和国家

![image-20240912103015928](../images/image-20240912103015928.png)

ISP：Internet服务商

IXP或IX：互联网交换点

#### 网络组成

> [!NOTE]
>
> 计算机网络从逻辑功能上可划为通信子网和资源子网
>
> 



##### 网络边缘

**端系统**：位于互联网边缘与互联网相连的计算机和其他设备

- 端系统由各类主机(host)构成：桌面计算机、移动计算机、服务器、其他智能终端设备

##### 网络核心

由互联端系统的分组交换设备和通信链路构成的网状网络（网络+路由器）

###### 接入网

- 接入网的目标是将主机连接到边缘路由器上
- 边缘路由器是端系统Host去往任何其他远程端系统的路径上的第一台路由器

*各种异构网络通过边缘路由器接入*

- 光纤到户FTTH：Firber to the home
- 数字用户线DSL：Digital Subscriber Line
- 同轴电缆：Cable
- 无线接入
  - 无线局域网WLAN
  - 广域蜂窝接入网



传输单位：bit

> [!WARNING]
>
> 存储常用字节ByteK/M/G层级为2^10进制
> 传输常用比特BitK/M/G层级为10^3进制
>
> 1B=8b （注意大小写）

###### 物理媒介

- 是指发射机和接收机之间的具体链路介质
- 引导型介质：信号在固体介质中传播，例如铜、光纤、同轴电缆
- 非引导型介质：信号自由传播，包括无线电（陆地无线电、卫星无线电信道）、无线链路类型（无线局域网（WiFi）、广域（如3/4/5G蜂窝）蓝牙、地面微波、卫星）

###### 网络核心两大功能

![image-20240912104651823](../images/image-20240912104651823.png)

#### 分组交换和电路交换

##### 分组交换（也称包交换 packet switching）

- 主机将数据分成分组，发送到网络，通信双方以分组为单位、使用存储-转发机制，实现数据交互的通信方式
- 网络将数据分组从一个路由器转发到下一个路由器，通过从源到目标的路径上的链路，逐跳传输抵达目的地
- 每个分组在互联网中独立的选择传输路径
- 支持灵活的统计多路复用 multiplexing
- 到达包的顺序和发送顺序可能不一致
- 附加信息开销大

##### 电路交换（circuit switching）

- 通信、传输时延小
- 资源预留，不会被抢占 -> 有序、性能有保障
- 容错性低（无法应对互联网中广泛存在的“突发”（Burst）流量）
- 资源利用不够充分

##### 存储转发的报文交换（Message switching）

- 路由器需要接收到完整的整个数据报文后，才能开始向下一跳发送
- 有传输延迟
- 同一报文的不同分组可以经过不同的传输路径通过通信子网

![image-20240912110029010](../images/image-20240912110029010.png)

总结：**分组交换在实际应用率最高**

### 协议和分层结构

分层协议 layered protocol

#### 协议设计目的

- 可靠性、资源分配、拥塞问题、自适应性、安全问题

##### 统一标准

- 明晰简化，便于分析学习
- 各层独立，加速技术演进
- 统一接口，确保技术互通（interoperable）

##### 模块独立

##### 分层结构

不同机器上的同一层称为对等层，同一层的实体称为对等实体

![image-20240912111717713](../images/image-20240912111717713.png)

发送端：层层封装；接收端：层层解封装

不同层对应协议数据单元（PDU Protocol Data Unit）

![image-20240912112646001](../images/image-20240912112646001.png)

从顶层到底层，每一层Header往前加，后面（前一层的header等）都是数据

#### 服务原语

服务原语 Service Primitives：请求 request、指示 indication、响应 response、证实 confirmation

- 面向连接（电话系统）/无连接（邮政系统）

![image-20240912113244482](../images/image-20240912113244482.png)



#### 服务与协议的关系

==协议是“水平”的，服务是“垂直”的==

➢ 实体使用协议来实现其定义的服务
➢ 上层实体通过接口使用下层实体的服务

### 参考模型

#### OSI参考模型

OSI：Open Systems Interconnection

**7层模型：从下到上，物理层、数据链路层、网络层、传输层、会话层、表示层、应用层**

##### 物理层（Physical Layer）

定义如何在信道上**传输比特**0、1：Bits on the wire

##### 数据链路层 (Data Link Layer)

数据链路层的传输单位是帧；点到点通信

实现相邻（Neighboring）网络实体间的数据传输

成帧（Framing）：从物理层的比特流中提取出完整的帧

物理地址（MAC address）：48位，理论上唯一网络标识，烧录在网卡，不便更改

共享信道上的访问控制（MAC）：同一个信道，同时传输信号。

数据链路层协议有：SDLC\HDLC\PPP\STP

##### 网络层 (Network Layer)

网络层的传输单位是数据报

将数据包跨越网络从源设备发送到目的设备（host to host）

路由（Routing）：在网络中选取从源端到目的端转发路径，常常会根据网络可达性动态选取最佳路径，也可以使用静态路由

网络层的控制主要面向运营商

> [!NOTE]
>
> 为什么除了MAC地址外，还有IP地址？不能用MAC（网卡地址）寻址，路由器不知道网卡在哪；？？面向运营商（第一节课）

网络层的协议有：IP\IPX\ICMP\IGMP\ARP\RARP\RIP\OSPF等

##### 传输层 (Transport Layer)

将数据从源端口发送到目的端口（进程到进程）

传输层为终端用户提供**端到端的数据传输控制**

两类模式：可靠的传输模式，或不可靠传输模式

- 可靠传输：可靠的端到端数据传输，适合于对通信质量有要求的应用场景，如文件传输等
- 不可靠传输：更快捷、更轻量的端到端数据传输，适合于对通信质量要求不高，对通信响应速度要求高的应用场景，如语音对话、视频会议等

传输层的协议有：TCP\UDP

##### 会话层 (Session Layer)

利用传输层提供的服务，在应用程序之间建立和维持会话，并能使会话获得同步

##### 表示层（Presentation Layer）

关注所传递信息的语法和语义，管理数据的表示方法，
传输的数据结构

##### 应用层（Application Layer）

通过应用层协议，提供应用程序便捷的网络服务调用

#### TCP/IP参考模型

**4个层!**

➢ 链路层（Link Layer）

- 描述了为满足无连接的互联网络层需求，链路必须具备的功能

➢ 互联网层（Internet Layer）

- 允许主机将数据包注入网络，让这些数据包独立的传输至目的地，并定义了数据包格式和协议（IPv4协议和IPv6协议）

➢ 传输层（Transport Layer）

- 允许源主机与目标主机上的对等实体，进行端到端的数据传输：TCP，UDP

➢ 应用层（Application Layer）

- 传输层之上的所有高层协议：DNS、HTTP、FTP、SMTP

> [!NOTE]
>
> 先有TCP/IP协议栈，然后有TCP/IP参考模型
>
> 参考模型只是用来描述协议栈的
>
> ARPNET最终采用TCP和IP为主要协议

#### OSI模型TCP/IP模型对比

<img src="../images/image-20240912120256033.png" alt="image-20240912120256033" style="zoom:50%;" />

<img src="../images/image-20240912120319889.png" alt="image-20240912120319889" style="zoom:50%;" />

> [!IMPORTANT]
>
> 本课程采用5层模型，物理层、数据链路层、网络层、传输层、应用层

#### 模型与网络实例

<img src="../images/image-20240912120815348.png" alt="image-20240912120815348" style="zoom:50%;" />

Host上每个层都有

交换机不解析IP地址，只处理MAC地址

路由器处理网络地址（IP地址） 

### 计算机网络度量单位

#### 速率/比特率(bit rate)

- 主机在数字信道上传送数据的速率，也称数据率
- 比特率的单位是b/s(比特每秒)，也可以写为bps，(bit per second)，或 kbit/s、Mbit/s、 Gbit/s等

#### 带宽(bandwidth)

- 网络中某通道传送数据的能力，即单位时间内网络中的某信道所能通过的“最高数据率”
- 单位是 bit/s，即 “比特每秒”
- $带宽=发送数据大小/传播时延$

#### 包转发率(PPS)

- 全称是Packet Per Second(包/秒)，表示交换机或
路由器等网络设备以包为单位的转发速率
- 线速转发（line speed）：交换机端口在满负载的情况下，对帧进行转发时能够达到该端口线路的最高速度

> [!NOTE]
>
> 在交换机上：大包和小包，哪个更容易实现线速？小的

#### 时延(Delay)

时延 (delay 或 latency) 是指数据（一个报文或分组）从网络（或链路）的一端传送到另一端所需的时间，也称为延迟

- **传输时延/发送时延(transmission delay)**：数据从结点进入到传输媒体所需要的时间

$$
\text{发送时延}=\text{分组长度}/\text{发送速率}
$$

- **传播时延(propagation delay)**：电磁波在信道中需要传播一定距离而花费的时间

$$
\text{传播时延}=\text{信道长度}/\text{电磁波在信道上的传播速率}
$$

- **处理时延(processing delay)**：主机或路由器在收到分组时，为处理分组（例如分析首部、提取数据、差错检验或查找路由）所花费的时间
- **排队时延(queueing delay)**：分组在路由器输入输出队列中排队等待处理所经历的时延 -> queue不长不短最好

![image-20240912122025795](../images/image-20240912122025795.png)

#### 往返时延RTT(Round-Trip Time)

- 从发送方发送数据开始，到发送方收到来自接收方的确认，经历的总时间
- 可用于判断网络的通断性、测试网络时延、计算数据包丢失率等

#### 时延带宽积

$时延带宽积 = 传播时延 \times 带宽$，即按比特计数的链路长度

EG: 传播时延为20ms，带宽为10Mb/s，则：时延带宽积= 20/1000 × 10×106 = 2 × 105 bit

吞吐量 throughput

有效吞吐量 goodput

信道利用率

丢包率



传输m个分组所需时间：T=(路由器数量+1)r + (m-1)r，r=分组大小/传输速率

### 网络安全威胁

恶意软件、病毒、蠕虫

##### 拒绝服务攻击(Denial-of-Service (DoS) attack)

攻击者通过制造大量虚假流量占用资源

使合法流量无法使用资源(服务、带宽

##### 僵尸网络 （Botnet）

采用一种或多种传播手段，将大量主机感染bot程序（僵尸程序）病毒，从而在控制者和被感染主机之间所形成的一个可一对多控制的网络
➢ 分布式DoS攻击的发起者，往往通过僵尸网络发起攻击，从而躲避追查

##### 如何防御

➢ 身份验证：证明你就是你！
➢ 保密：加密技术
➢ 完整性检查：数字签名检测/防止篡改
➢ 访问限制：受密码保护的VPN
➢ 防火墙：接入网络和核心网络中的专用“安全卫士”

### 标准化组织

ISO、ITO、IEEE、WFA、IETF、IRTF(Interent research of )

- RFC(request for comments)标准

### 互联网发展史与启示

1983 ARPANET采用TCP/IP——标志互联网诞生

### 总结

主机A给主机B发送数据的理论最高速率取决于链路带宽、主机A/B网卡速率的最小者



## 物理层

### 物理层基本概念

#### 物理层功能

**位置**：物理层是网络体系结构中的最低层

> [!WARNING]
>
> 不是连接计算机的具体物理设备，不是负责信号传输的具体物理媒体

**功能**：如何在连接各计算机的传输媒体上*传输数据比特流*

**作用**：尽可能地*屏蔽掉不同传输媒体和通信手段的差异*

#### 物理层特性

##### 物理层机械特性

涉及接口的物理结构，通常采用接线器来实现机械上的连接

**定义**接线器的**形状和尺寸、引线数目和排列、固定和锁定装置**等

##### 物理层电气特性

规定了多条信号线的电气连接及有关电路特性

- 发送器和接收器的电路特性、负载要求、传输速率和连接距离等
- 如发送信号电平、发送器和接收器的输出阻抗、平衡特性等

##### 物理层功能特性

描述接口执行的功能，定义接线器的每一引脚(针，Pin)的作用

##### 物理层过程特性

指明对于不同功能的各种可能事件的出现顺序

#### 物理层标准及示例

**点对点通信线路**用于直接连接两个结点

广播通信线路



### 数据通信基础

#### 数据通信基础理论

##### 傅里叶分析

任何一个周期为T的有理周期性函数 g(t) 可分解为若干项（可能无限多
项）正弦和余弦函数之和
$$
g(t)=c+\sum_{n=1}^∞{a_nsin(2Πnft)}+\sum_{n=1}^∞{b_ncos(2Πnft)}
$$
f = 1/T 基本频率

a~n~, b~n~ n次谐波项的正弦和余弦振幅值

##### 有限带宽信号

信号在信道上传输时的特性

- 对不同傅立叶分量的衰减不同，引起输出失真
- 信道有**截止频率fc** , 0 ~ fc的振幅衰减较弱， fc以上的振幅衰减厉害，这主要由信道的物理特性决定， **0 ~ fc是信道的有限带宽**
- 实际使用时，可以接入滤波器，限制用户的带宽
- 通过信道的**谐波次数N越多，信号越逼真**
EG：<img src="../images/image-20240919110243928.png" alt="image-20240919110243928" style="zoom:50%;" />

#### 信道的最大数据传输速率

##### 奈魁斯特定理

**无噪声**有限带宽信道的最大数据传输率公式

- 最大数据传输率 = $2Hlog_2V$​ (bps)
- 任意信号通过一个*带宽为Ｈ*的低通滤波器，则*每秒采样2H次（频率）*就能完整地重现该信号（无损！），*信号电平分为V级*

--------------------------------------

EG：无噪声理想信道带宽4MHz，QAM调制，信道最大数据传输速率为48Mb/s，则QAM调制方案是？

> $2Hlog_2V=48Mb/s$，H=4MHz，V=64 ==> QAM-64

> [!NOTE]
>
> Symbol rate vs. Data rate
>
> symbol代表若干个比特，symbol rate又叫baud rate
>
> data rate = symbol rate * bits per symbol
>
> **The modulation technique determines the number of bits/symbol**

##### 信噪比

随机噪声出现的大小用**信噪比**（**信号功率S**与**噪声功率N**之比）来衡量

- 信噪比=$10log_{10}S/N$，单位：分贝db

##### 香农定理

带宽为*H赫兹*，*信噪比为S/N*的任意信道的**最大数据传输率**为：$$Hlog_2(1 + S/N)$$ (bps)

- 此式是利用信息论得出的，具有普遍意义
- 与信号电平级数、采样速度无关
- 此式仅是上限，难以达到

##### 信息量

一条消息包含信息的多少称为信息量

- 信息量的大小与消息所描述事件的出现概率有关
- 一条消息所荷载的**信息量**等于它所表示的事件发生的**概率p**的倒数的对数$I=log_a{\frac{1}{p}}=-log_ap$
  - a表示进制，a=2时，I的单位为比特；a=自然数e，I的单位为奈特，通常用**比特**作为信息量的单位

#### 数据通信系统模型

信号是消息的载体

##### 传输方式

- 串行、并行
- 点到点/点到多点
- 单工（sender—>receiver，方向指定）、半双工（双向但不能同时）、全双工（双向可同时）
- 基带传输、频带传输

##### 数据编码技术

1. 不归零制码（NRZ：Non-Return to Zero）
   - 原理：用两种不同的电平分别表示二进制信息“0”和“1”，低电平表示“0”，高电平表示“1”
   - 缺点：难以分辨一位的结束和另一位的开始；发送方和接收方必须有时钟同步；若信号中“0”或“1”连续出现，信号直流分量将累加
   - 结论：容易产生传播错误
2. 曼彻斯特码（Manchester），也称相位编码
   - 原理：每一位中间都有一个跳变，从低跳到高表示“0”，从高跳到低表示“1”
   - 优点：克服了NRZ码的不足。每位中间的跳变即可作为数据，又可作为时钟，能够自同步
3. 差分曼彻斯特码（Differential Manchester）
   - 原理：每一位中间都有一个跳变，每位开始时有跳变表示“0”，无跳变表示“1”。位中间跳变表示时钟，位前跳变表示数据
   - 优点：时钟、数据分离，便于提取

<img src="../images/image-20240919115358181.png" alt="image-20240919115358181" style="zoom:50%;" />

频带传输

**三种调制技术**：载波 Asin(ωt + φ)的三个特性幅度、频率、相位

- 幅移键控法（调幅） Amplitude-shift keying (ASK)
	幅移就是把频率、相位作为常量，而把振幅作为变量
- 频移键控法 （调频）Frequency-shift keying (FSK)
	频移就是把振幅、相位作为常量，而把频率作为变量
- 相移键控法（调相） Phase-shift keying (PSK)
	相移就是把振幅、频率作为常量，而把相位作为变量

常见调制方式：

BPSK：使用了基准的正弦波和相位反转的波浪，使一方为0，另一方为1，从而可以同时传送接受2值(1比特)的信息

QPSK：一种四进制相位调，制采用移相方式QPSK，每个点2比特信息，具有良好的抗噪特性和频带利用率通信业

QAM：正交幅度调制是是一种数字调制方式，产生的方法有正交调幅法和复合相移，16QAM是指包含16种符号的QAM调制方式（用4个symbol）



### 传输介质

#### 分类

##### 导引性介质

指电磁波被导向沿着某一媒体传播，包括双绞线、同轴电缆、电力线和光纤等

###### 磁介质(magnetic tape)

- 顺序读写

- Bandwidth 带宽 = 800GB/tape * 1000 tapes/box / (24×60×60s) = 70+Gbps

- Cost = (800GB/tape × 1000tapes/box) / 5000\$ = 160GB/$

> Never underestimate the bandwidth of station wagon full of tapes hurtling down the highway. 带宽很大，但延迟多

###### 双绞线（网线）

- 绞合密度、扭绞方向和绝缘材料等因素影响双绞线的特性阻抗、衰减和近端串扰

###### 同轴电缆

- 寿命长、容量大、传输稳定、外界干扰小、维护方便等优点

###### 光纤

- 双层或多层同心园柱体（类似同轴电缆），由纤芯、包层和护套组成
- 三种实用光纤
  - 单模 纤芯直径很小，折射率分布属于突变型 带宽极大，适用于大容量远距离通信
  - 多模突变 带宽较窄，适用于小容量短距离通信
  - 多模渐变 纤带宽较宽，适用于中容量中距离通信

光纤损耗和波长有关系，三个窗口

光纤损耗分为

- 固有损耗指光纤材料的性质和微观结构引起的吸收损耗和瑞利散射损耗
- 非固有损耗指杂质吸收、结构不规则引起的散射和弯曲幅射损耗等

###### 电力载波

电力载波是电力系统特有的通信方式

- 利用现有电力线，通过载波方式将模拟或数字信号进行高速传输

- 交流电信号+信号=调制信号

优点：投资少、连接方便、传输速率高、安全性好和使用范围广

缺点：无法提供高质量的数据传输业务，如家庭电器产生的电磁波干扰等

##### 非导引性介质

指电磁波在大气层、外层空间或海洋中进行的无线传播，包括短波传输、地面微波、卫星微波、光波传输等

###### 短波传输（无线电波）

100m～10m 波长长->绕射能力强->传播距离远

多径传播：短波电波通过若干条路径或者不同的传播模式由发信点到达收信点的长度不同，而引起由发信点到达收信点的时间不同的现象

多径时散：指不同路径的时延差；与路径长度、工作频率、昼夜、季节等因素有关

- 多径时散对数据通信的影响主要体现在码间干扰
- 为了保证传输质量，往往采用限制数据传输速率的措施

散射传输：利用大气层中传输媒体的不均匀性对无线电波的散射作用进

行的超视距通信

###### 微波

1m～1mm

多路复用、射频工作和中继接力是地面微波传输的三个最基本的工作特点

波长 m * 频率 Hz = 速度 m/s

###### 光波

3×10^2^～60×10^4^μm

分类

- 按照光源特性的不同，分为激光通信和非激光通信
- 按照传输媒体的不同，分为大气激光通信和光纤通信
- 按照传输波段的不同，光波通信分为可见光通信、红外线（光）通信和紫外线（光）通信

大气激光通信可传输语音、数据、图像等信息

- 具有抗干扰性好、设备轻便、保密性强、机动性

- 但使用时收、发天线相互对准较为困难，通信距离限于视距范围

- 易受气候影响，尤其在恶劣气候条件下会造成通信中断

###### 红外线

不可见光，其波长范围760nm~4.0*10^5^nm



### 无线与卫星通信

**无线传输：**可以在自由空间利用电磁波发送和接收信号进行通信

**无线电波**：指在自由空间（包括空气和真空）传播的射频频段的电磁

波

<img src="../images/image-20240926111831530.png" alt="image-20240926111831530" style="zoom:50%;" />

**卫星通信**:利用人造地球卫星作为中继站，转发或反射无线电波，在两

个或多个地球站之间进行的通信

特点

- 传播时延长，从一个地球站经卫星到另一个地球站的电波传播传播时间约需240～280ms（可取270ms） 
- 传播损耗大，达200dB左右
- 受大气层的影响大
- “面覆盖”式的传播信道

卫星通信的缺点

- 传输时延大：500毫秒~800毫秒的时延

- 高纬度地区难以实现卫星通信

- 为了避免各卫星通信系统之间的相互干扰，同步轨道的星位是有一点限度的，不能无限制地增加卫星数量

- 太空中的日凌现象和星食现象会中断和影响卫星通信

**移动卫星通信**

静止轨道~

中轨道~

低轨道~(LEO)

- 信号传输时延小
- 地面终端设备简单、造价低，是手持式终端的最佳方式
- 卫星造价低、发射容易

### 多路复用技术

复用 (multiplexing) 技术的目的是：允许用户使用一个共享信

道进行通信，避免相互干扰，降低成本，提高利用率。

#### 频分复用(FDM)

频分复用（Frequency-division multiplexing），是一种将多路基带信号调制到不同频率载波上，再进行叠加形成一个复合信号的多路复用技术

频分复用的所有用户在同样的时间*占用不同的带宽资源*（请注意，这里的“带宽”是**频率带宽**而不是数据的**发送速率**）



#### 时分复用(TDM)与统计时分复用(STDM)

**时分复用**(Time Division Multiplexing)是将时间划分为一段段等长的时分复用帧

- 每一个时分复用的用户在每一个 TDM 帧中占用固定序号的时
- 每一个用户所占用的时隙是周期性地出现（其周期就是TDM帧的长度）的。
- TDM 信号也称为等时 (isochronous) 信号。
- 时分复用的所有用户在*不同的时间*占用**同样的频带宽度**
- **存在的不足：**使用时分复用系统传送计算机数据时，由于计算机数据的突发性质，用户对分配到的子信道的利用率一般是不高的

**统计时分复用**（statistical time division multiplexing）是指动态地按需分配共用信道的时隙，只将需要传送数据的终端接入共用信道，以提高信道利用率的多路复用技术

#### 波分复用(WDM)

**波分复用**（Wavelength Division Multiplexing，WDM）是利用*多个*激光器在*单条*光纤上同时发送*多束不同波长激光*的技术



#### 码分复用(CDMA)

码分多址 (Code Division Multiple Access，CDMA)是指利用码序列相关性实现的多址通信 , 基本思想是靠**不同的地址码**来区分的地址

- 各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰
- 这种系统发送的信号有很强的抗干扰能力，其频谱类似于白噪声，不易被敌人发现

![image-20240926113349556](../images/image-20240926113349556-1727322379769-1.png)

**码片序列的正交关系**

正交就是向量 S 和T 的规格化内积 (inner product) 等于 0

<img src="../images/image-20240926114344682.png" alt="image-20240926114344682" style="zoom:50%;" />

**码片序列实现了扩频(spread spectrum)**

假定S站要发送信息的数据率为 *b* bit/s。由于每一个比特要转换成 *m* 个比特的码片，因此 S 站实际上发送的数据率提高到 *mb* bit/s，同时 S 站所占用的频带宽度也提高到原来数值的 *m* 倍

#### 正交频分复用(OFDM)

正交频分复用（Orthogonal Frequency Division Multiplexing，OFDM)

- 将信道分成若干正交子信道
- 将高速数据信号转换成并行的低速子数据流，调制到在每个子信道上进行传输

问题：

Wideband (e.g., 10MHz) ==> short symbol time (e.g., 0.1µs) 

- Delay spread caused by multipath transmission: about 1µs ==> 0.1µs << 1µs ==> severe inter-symbol interference (ISI)

解决方法：

Divide the wideband into many narrow bands, each with a carrier (i.e., subcarrier)宽带变窄带

For example：10MHz --> 100 subcarriers --> symbol time 10µs --> 10µs >> delay spread (1µs) --> smaller ISI

- Multi-carrier modulation 

#### 空分复用



## 数据链路层基础

### 数据链路层的设计问题

#### 数据链路层在协议栈中的位置

向下：利用物理层提供的位流服务

向上：向网络层提供明确的 (well-defined) 服务接口

<img src="../images/image-20240926120633253.png" alt="image-20240926120633253" style="zoom:50%;" />

#### 数据链路层的功能

**成帧（Framing）**

- 将比特流划分成“帧”的主要目的是为了检测和纠正物理层在比特传输中可能出现的错误，数据链路层功能需借助“帧”的各个域来实现

**差错控制（Error Control）** 

- 处理传输中出现的差错，如位错误、丢失等

流量控制（Flow Control） （重点前两个）

- 确保发送方的发送速率，不大于接收方的处理速率
- 避免接收缓冲区溢出

#### 数据链路层提供的服务

无确认无连接（ Unacknowledged connectionless ） 

- 接收方不对收到的帧进行确认

- 适用场景：误码率低的可靠信道；实时通信（延迟低）

- 网络实例：以太网

有确认无连接（ Acknowledged connectionless ） 

- 每一帧都得到单独的确认

- 适用场景：不可靠的信道（无线信道）

- 网络实例：802.11

有确认有连接（ Acknowledged connection-oriented ） 

- 适用场景：长延迟的不可靠信道，例如卫星通信

#### 成帧 framing

<img src="../images/image-20241010094050531.png" alt="image-20241010094050531" style="zoom:50%;" />

**定界符**标识一个帧的开始

- **字节计数法**（ Byte count ） ：无差错传输的情形，现实中很少用（多米诺骨牌式错误

  - <img src="../images/image-20241027153503965.png" alt="image-20241027153503965" style="zoom:50%;" />

- **带字节填充的定界符法**（ Flag bytes with byte stuffing）

  - 定界符：一个特殊的字节，比如 01111110，即 0x7E，用于区分前后两个不同的帧
  - 发送发将数据（有效载荷）中加入*转义字符*加以区分
    <img src="../images/image-20240926121740625.png" alt="image-20240926121740625" style="zoom:50%;" />
  - 接收方逐个检查收到的每一个字节
    - 收到ESC，则后一字节无条件成为有效载荷，不予检查
    - 收到FLAG，则为帧的边界

  > 不足：overhead 开销大、效率低

- **带比特填充的定界符法**（ Flag bits with bit stuffing ）

  - 定界符：两个0比特之间，连续6个1比特，即01111110，0x7E
  - 发送方在数据（有效载荷）中出现连续5个1比特，则直接插入1个0比特 -->*数据中不会出现定界符*
  - 接收方若出现连续5个1比特
    - 若下一比特为0，则为有效载荷，直接丢弃0比特
    - 若下一比特为1，则连同后一比特的0，构成定界符，一帧结束

- **物理层编码违例**（ Physical layer coding violations ）

  - - 核心思想：选择的定界符不会在数据部分出现


#### 差错控制

链路层存在的一个问题：信道的噪声导致数据传输问题

- 差错（ incorrect ）：数据发生错误

- 丢失（ lost ）：接收方未收到

- 乱序（out of order）：先发后到，后发先到

- 重复（repeatedly delivery）：一次发送，多次接收

:hand: 解决方案：差错检测与纠正、确认重传

- 确认：接收方校验数据（差错校验），并给发送方应答，防止差错

- 定时器：发送方启动定时器，防止丢失

- 顺序号：接收方检查序号，防止乱序递交、重复递交

#### 流量控制

链路层存在的另一个问题：接收方的处理速率

- 接收方的接收缓冲区溢出

:hand: 解决方案

- 基于反馈 (feedback-based) 的流量控制

- 接收方反馈，发送方调整发送速率

- 基于速率 (rate-based) 的流量控制

- 发送方根据内建机制，自行限速

### 差错检测和纠正

通常采用增加冗余信息（或称校验信息）的策略

- 示例：每个比特传三份，如果每比特的三份中有一位出错，可以纠正

#### 检错码（error-detecting code） 

在被发送的数据块中，包含一些冗余信息，但这些信息只能使接收方推断是否发生错误，但不能推断哪位发生错误，接收方可以请求发送方重传数据

- 主要用在**高可靠、误码率较低**的信道上，例如光纤链路
- 偶尔发生的差错，可以通过重传解决差错问题

#### 纠错码（error-correcting code)

发送方在每个数据块中加入足够的冗余信息，使得接收方能够判断接收到的数据是否有错，并能纠正错误（*定位出错的位置*） 

- 主要用于**错误发生比较频繁**的信道上，如无线链路
- 也经常用于物理层，以及更高层（例如，实时流媒体应用和内容分发）
- 使用纠错码的技术通常称为*前向纠错*（FEC，Forward Error Correction)

**码字 (code word)**：一个包含m个数据位和r个校验位的n位单元，描述为 (n, m) 码，n=m+r

**码率 (code rate)**：码字中不含冗余部分所占的比例，可以用m/n表示

#### 海明距离 (Hamming distance)

给定m的条件下，纠正单个错误所需校验位数的下限：$m+r+1≤2^r$

- m为消息位个数，r为校验位个数

**两个码字的海明距离**：两个码字之间不同对应比特的数目

- 例：0000000000 与0000011111的海明距离为5 
- 如果两个码字的海明距离为d，则需要d个单比特错就可以把一个码字转换成另一个码字 

**一种编码方案（code）的海明距离**

- 该编码方案中**任意**两个**合法**码字的**最小**海明距离

<img src="../images/image-20241010101507783.png" alt="image-20241010101507783" style="zoom:50%;" />

==The error-detection and error-correcting properties of a code depend on its Hamming distance.== 代码的错误检测和纠错特性取决于其海明距离

<img src="../images/image-20241010101647584.png" alt="image-20241010101647584" style="zoom:50%;" />

To use Hamming distance to correct *d* errors: you need *2d*+1 Hamming distance code. 用海明距离纠正d个错误需要2d+1个距离码

-----------------

<img src="../../../note/docs/images/image-20241026190950023.png" alt="image-20241026190950023" style="zoom:50%;" />

图3-6纠正1位错误的海明码：海明距离为3，可以纠正1个错误或者检测两个错误

#### 典型检错码

常用的检错码包括：

- 奇偶检验 (Parity Check)：1位奇偶校验是最简单、最基础的检错码
- 校验和 (Checksum)：主要用于TCP/IP体系中的网络层和传输层
- 循环冗余校验 (Cyclic Redundancy Check，CRC)：数据链路层广泛使用的校验方法，crc只能检错不能纠错



##### 奇偶校验

1位奇偶校验：增加1位校验位，**可以检查奇数位错误**

-> 1个bit的错误

- 偶校验：保证1的个数为偶数个
- 奇校验：保证1的个数为奇数个

##### 校验和

<img src="../images/image-20241010103018514.png" alt="image-20241010103018514" style="zoom:50%;" />

##### 循环冗余校验CRC

<img src="../images/image-20241010103456548.png" alt="image-20241010103456548" style="zoom:50%;" />

<img src="../images/image-20241010103759787.png" alt="image-20241010103759787" style="zoom:50%;" />

> [!NOTE]
>
> <img src="../images/image-20241010104633476.png" alt="image-20241010104633476" style="zoom:50%;" />

#### 海明码 hamming code

<img src="../images/image-20241010104906952.png" alt="image-20241010104906952" style="zoom:50%;" />

<img src="../images/image-20241010105010202.png" alt="image-20241010105010202" style="zoom:50%;" />

纠正

<img src="../images/image-20241010105806099.png" alt="image-20241010105806099" style="zoom:50%;" /><img src="../images/image-20241010105834666.png" alt="image-20241010105834666" style="zoom:50%;" />

<img src="../images/image-20241010105936347.png" alt="image-20241010105936347" style="zoom:50%;" />

按列发，每行最多错一位，可以纠正

[最通俗易懂的海明码校验纠错讲解_海明码纠错-CSDN博客](https://blog.csdn.net/hamster204/article/details/90748043)

#### 卷积码 Convolutional Code

​						

#### Trellis diagram

<img src="../images/image-20241010112646389.png" alt="image-20241010112646389" style="zoom:40%;" />

> <img src="../images/image-20241010113409601.png" alt="image-20241010113409601" style="zoom:50%;" />
>
> S0->S2->S3->S1 输出state 00 11 01 01 原始数据：0 1 1 0

### 基本的数据链路层协议

#### 关键假设

:hand: 分层进程独立假设

- 网络层、数据链路层、物理层为独立的进程

- 进程间通过传递消息实现通信

:hand: 提供可靠服务假设

- 提供可靠的、面向连接的服务

- 数据链路层发送的数据随时可向网络层获得

:hand: 只处理通信错误假设

- 仅处理通信错误

- 假设机器不会崩溃，不考虑断电、重启等引起的问题

#### 基本的协议定义

![image-20241010114039440](../images/image-20241010114039440.png)

#### 乌托邦式单工协议

假设

- 单工（Simplex）协议：数据单向传输

- 完美信道：帧不会丢失或受损

- 始终就绪：发送方/接收方的网络层始终处于就绪状态

- 瞬间完成：发送方/接收方能够生成/处理无穷多的数据

:hand: 乌托邦：完美但不现实的协议

- 不处理任何流量控制或纠错工作

- 接近于无确认的无连接服务，必须依赖更高层次解决上述问题



#### 无错信道单工停止-等待协议

不再假设

- 接收方能够处理以无限高速进来的数据

- 发送方以高于接收方能处理到达帧的速度发送帧，导致接收方被“淹

没”(overwhelming)

:hand: 仍然假设

- 通信信道不会出错（Error-Free） 

- 数据传输保持单向, 但是需要双向传输链路（半双工物理信道）

<img src="../images/image-20241010114532082.png" alt="image-20241010114532082" style="zoom:50%;" />



#### 有错信道单工停止-等待协议

➡️假设

- 通信信道可能会出错，导致：

−帧在传输过程中可能会被损坏，接收方能够检测出来

−帧在传输过程中可能会丢失 ，永远不可能到达接收方

➡️一个简单的解决方案

- 发送方增加一个*计时器(timer)*，如果经过一段时间没有收到确认，发送方将超时，于是再次发送该帧

stop and wait

<img src="../images/image-20241010115024755.png" alt="image-20241010115024755" style="zoom:50%;" />

![image-20241010115505791](../images/image-20241010115505791.png)

**效率的评估**

F = frame size (bits) 
R = channel capacity (Bandwidth in bits/second)
I = propagation delay + processor service time (second)

- 每帧发送时间 (Time to transmit a single frame) = F/R

- 总延迟 (Total Delay) = D =2I

- 停止等待协议的发送工作时间是F/C，空闲时间是D 

当 F<D 时：==信道利用率 (line utilization)=F/(F+R·D) < 50%==

#### 停等协议的性能问题

:hand: 停止-等待机制降低了信道利用率

- 设数据速率记为R，帧长度记为F，往返延迟记为D，则采用停-等协议的

线路效率为：F/(F+R·D)

- 假如将链路看成是一根管道，数据是管道中流动的水，那么在传输延迟

较长的信道上，停-等协议无法使数据充满管道，因而信道利用率很低

:hand: 解决办法

- 流水线协议或管道协议：允许发送方在没收到确认前连续发送多个帧

### 滑动窗口协议

#### 滑动窗口协议

窗口机制

− 发送方和接收方都具有一定容量的缓冲区（即窗口），发送端在收到确认

之前可以发送多个帧

目的

- 对可以连续发出的最多帧数（已发出但未确认的帧）作限制

:hand: 序号使用

- 循环重复使用有限的帧序号

:hand: 流量控制：接收窗口驱动发送窗口的转动

- 发送窗口：其大小记作WT，表示在收到对方确认的信息之前，可以连续发出的最多数

据帧数

- 接收窗口：其大小记作WR ，为可以连续接收的最多数据帧数

:hand: 累计确认：不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认

<img src="../images/image-20241010121042703.png" alt="image-20241010121042703" style="zoom:50%;" />

收到，前窗口后移，后窗口不动；发出确认后，后窗口才后移

#### 回退N协议（协议5）

##### 协议原理分析

出错全部重发

- 当接收端收到一个出错帧或乱序帧时，丢弃所有的后继帧，并且不为这

些帧发送确认

- 发送端超时后，重传所有未被确认的帧

:hand: 适用场景

- 该策略对应接收窗口为1的情况，即只能按顺序接收帧

:hand: 优缺点

- 优点：连续发送提高了信道利用率

- 缺点：按序接收，出错后即便有正确帧到达也丢弃重传

<img src="../images/image-20241010121610811.png" alt="image-20241010121610811" style="zoom:50%;" />

##### 协议的实现分析

<img src="../images/image-20241010122334745.png" alt="image-20241010122334745" style="zoom:50%;" />

#### 选择重传协议 select and repeat（协议6）

若发送方发出连续的若干帧后，收到对其中某一帧的否认帧，或某一帧的定时器超时，则**只重传该出错帧或计时器超时的数据帧**

该策略对应接收窗口大于1的情况，即暂存接收窗口中序号在出错帧之后的数据帧

- 优点：避免重传已正确传送的帧
- 缺点：在接收端需要占用一定容量的缓存

##### 基本原理

- 在发送过程中，如果一个数据帧计时器**超时**，就认为该帧丢失或者被破坏；**接收端只把出错的的帧丢弃，其后面的数据帧保存在缓存中**，并向发送端回复NAK；发送端接收到NAK时，**只重传出错的帧**

- 如果**落在窗口内的帧**从未接受过，那么存储起来，等比它序列号小的所有帧都正确接收后，按次序交付给网络层

- 接收端收到的数据包的顺序可能和发送的数据包顺序不一样，因此在数据包里必须含有**顺序号**来帮助接收端进行排序。

没有累计确认的机制

滑动窗口长度

- 发送窗口的尺寸：$$W^T ≤2^{n-1}$$​,发送窗口应等于或小于序号空间的一半

##### 协议实现分析

发送方必须响应的三件事

- 上层的调用：检测有没有可以使用的序号，如果有就发送
- 收到ACK：如果收到的是最小序号的ACK，窗口滑动。如果收到其他序号的ACK，进行标记
- 超时事件：每个PDU都有定时器，哪个超时重传哪个

<img src="../images/image-20241017101807227.png" alt="image-20241017101807227" style="zoom:33%;" />

<img src="../images/image-20241017101844229.png" alt="image-20241017101844229" style="zoom:33%;" />



### 数据链路协议实例

#### 点到点链路层协议PPP

PPP协议是目前使用最多的数据链路层协议之一

能够在不同的链路上运行；能够承载不同的网络层分组

特点：简单、灵活

##### PPP协议实现的功能

##### PPP协议未实现的功能

帧数据的纠错功能

- 数据链路层的PPP协议**只进行检错**，PPP协议是不可靠传输协议

流量控制功能

- PPP协议未实现点到点的流量控制

可靠传输功能

- PPP为**不可靠协议**，不使用帧的序号。不可靠网络中可能使用有序号的工作方式。

多点连接功能

- PPP协议不支持多点线路，**只支持点对点**的链路通信。

单工和半双工链路

- PPP协议支持全双工链路

##### PPP协议的构成

封装 (Encapsulation)

- 提供在同一链路上支持不同的网络层协议
- PPP既支持异步链路（无奇偶检验的8比特数据），也支持面向比特的同步链路
- IP数据包在PPP帧中是其信息部分，其长度受到MTU的限制

链路控制协议 LCP (Link Control Protocol)。 

- 用来建立、配置和测试数据链路的链路控制协议，通信双方可协商一些选项

网络控制协议 NCP (Network Control Protocol)。 

- 其中每个协议支持一种不同的网络层协议，如IP、OSI的网络层、DECnet、AppleTalk等

##### PPP协议的帧格式

1.字节填充

避免在信息字段中出现和**标志字段**一样的比特组合（FLAG为0X7E） 

当PPP使用**异步传输**时，定义**转义字符**0X7D，并使用字节填充（ESC为0X7D）

- 将信息字段中出现的0x7E 字节转变成为2字节序列(0x7D, 0x5E)

2.零比特填充

PPP协议用在SONET/SDH链路时，使用**同步传输**（一连串的比特连续传送），不是异步传输（逐个字符地传送）

> 异步传输是面向字符的传输，而同步传输是面向比特的传输

#### PPPoE

Ethernet优点：原理简单，应用非常广，设备成本低

Ethernet缺点：安全性较低、不宜管理：使用广播信道，造成了安全性较低，无认证功能

PPP优点：

- 原理简单
- 安全性高：点对点信道，提供认证机制
- 提供良好的访问控制和计费功能

==>结合变成 PPPoE(Point-to-Point Protocol over Ethernet)

- 提供在以太网链路上的PPP连接
- 实现了传统以太网不能提供的身份验证、加密，以及压缩等功能
- 实现基于用户的访问控制、计费、业务类型分类等，运营商广泛支持
- PPPoE使用Client/Server模型，服务器通常是接入服务器

<img src="../images/image-20241017104019543.png" alt="image-20241017104019543" style="zoom: 33%;" />

## 介质访问子层

> 介质访问子层在数据链路层的下面

### 信道分配问题

#### 子信道的平均延迟



**信道N等分后每个子信道平均延迟时间会增加**（有害，增加N倍

#### 静态分配的特点

问题：资源分配不合理



### 多路访问协议

#### 随机访问协议

##### ALOHA协议

###### 纯ALOHA

原理：想发就发

特点：随时可能冲突

帧时：发送一个标准帧需要的时间

S 吞吐量：在发送时间T内发送成功的平均帧数，0<S<1

生成帧均值：2G (G：网络负载)

冲突危险期：2D (D：单向传播延迟)

$P_0$​ 成功传输概率：连续两个时间T内都没有生成其它帧的概率

$P_0=e^{-2G}$

纯ALOHA协议的性能：（吞吐率最大）18.4%

###### 分隙ALOHA(slotted ALOHA)

冲突危险期：D

分隙ALOHA协议的性能：（吞吐率最大）36.8%

##### 载波侦听多路访问协议(CSMA)

CSMA：Carrier Sense Multiple Access

特点：“先听后发” -> 改进ALOHA的侦听/发送策略分类

###### 非持续式CSMA

特点

①经侦听，如果介质空闲，开始发送

②如果介质忙，则等待一个随机分布的时间，然后重复步骤①

- 好处：等待一个随机时间可以减少再次碰撞冲突的可能性

- 缺点：等待时间内介质上如果没有数据传送，这段时间是浪费的

###### 持续式CSMA

特点

①经侦听，如介质空闲，则发送

②如介质忙，持续侦听，一旦空闲立即发送

③如果发生冲突，等待一个随机分布的时间再重复步骤①

- 好处：持续式的延迟时间要少于非持续式
- 缺点：如果两个以上的站等待发送，一旦介质空闲就一定会发生冲突

###### p-持续式CSMA

特点

①经侦听，如介质空闲，那么以 p 的概率发送，以**(1–p)的概率**延迟一个时间单元发送

②如介质忙，持续侦听，一旦空闲重复①

③如果发送已推迟一个时间单元，再重复步骤①

> [!NOTE]
>
> 冲突窗口

##### CSMA/CD （1-持续）

##### CSMA/CD（续）

在发完之前能知道有冲突



#### 受控访问协议

无冲突协议

##### 位图协议（预留协议）

竞争期：在自己的时槽内发送竞争比特

- 举手示意
- 资源预留

传输期：按序发送

- 明确的使用权，避免了冲突

<img src="../images/image-20241017114756997.png" alt="image-20241017114756997" style="zoom:33%;" />

###### 信道利用率分析

假设

- 有N个用户，需N个时隙，每帧d比特

信道利用率

- 在低负荷条件下：d/(d+N) （N越大，站点越多，利用率越低）
- 在高负荷条件下：d/(d+1)，接近100%

缺点

- 位图协议无法考虑优先级

##### 令牌





##### 二进制倒计数协议

站点：编序号，序号长度相同

竞争期：有数据发送的站点从高序号到低序号排队，高者得到发送权

特点：==高序号站点优先==

<img src="../images/image-20241017115104833.png" alt="image-20241017115104833" style="zoom:30%;" />

> **防止低序号站点一直抢不到发送权，可以怎样办？**
>
> 换编号 overhead

###### 信道效率分析

N个站的二进制编码所需位数是$$log_2N$$位 

信道的利用率为：$$d/(d+log_2N)$$

如果规定每个帧的帧头为发送地址，即竞争的同时也在发送。则效率为100%



#### 有限竞争协议

##### 自适应树搜索协议(Adaptive Tree Walk Protocol)

<img src="../images/image-20241017120328802.png" alt="image-20241017120328802" style="zoom:33%;" />

#### 无线LAN协议

MACA

### 以太网

#### 经典以太网

##### 经典以太网的物理层

最高速率10Mbps

:hand:使用曼彻斯特编码

:hand:使用同轴电缆和中继器连接

任意两个收发器之间距离不得超过2.5km（和CSMA/CD的delay有关

且任意两个收发器之间经过的中继器不能超过4个以保证MAC协议正常工作

##### MAC子层协议

主机运行CSMA/CD协议

常用的以太网MAC帧格式有两种标准 ： 

- DIX Ethernet V2 标准（最常用的）

- IEEE 的 802.3 标准



<img src="../images/image-20241107105937823.png" alt="image-20241107105937823" style="zoom:33%;" />

**二进制指数后退( Binary exponential backoff )的CSMA/CD**

<img src="../images/image-20241024101500636.png" alt="image-20241024101500636" style="zoom: 67%;" />

- 数字r小的优先（先发送）

$$
P=F/B\text{，F为帧长，B为带宽}\\
信道效率 = \frac{P}{P + 2𝜏/A}
\text{，传送一帧平均需要P秒，某个站获得信道的概率为A，2𝜏为时间槽}\\
信道效率 =\frac{1}{1 + 2BLe/cF}
\text{，L为电缆长度，c为信号传播速度；假设每帧e个竞争时间槽}
$$

电缆越长，𝜏越大，任何两个站之间的最大电缆距离会影响性能

在给定帧长的情况下，增加带宽或距离会降低网络效率



？？

#### 交换式以太网



#### 快速以太网

**fast Ethernet**( IEEE 802.3u, 1995 )

带宽：10Mbps -> 100Mbps

比特时间：100ns -> 10ns （电缆的最大长度降低到十分之一）

保留原来的工作方式（帧格式、接口、过程规则）



> [!NOTE]
>
> 名称中100Base意味着100Mbps的以太网

#### 千兆以太网

**gigabit Ethernet**( IEEE 802.3ab, 1998 )

100Mbps -> 1000Mbps( 1Gbps )

保留原来的工作方式（帧格式、接口、过程规则）

全双工和半双工两种方式工作

- 在半双工方式下使用 CSMA/CD （*为了向后兼容*），增加**载波扩充**和**帧突发**
- 全双工方式不需要使用CSMA/CD（*缺省方式*）

#### 万兆以太网

**10-Gigabit Ethernet**( IEEE 802.3ae, 2002 )

1Gbps -> 10Gbps

**只支持全双工，不再使用CSMA/CD**

保持兼容性

重点是超高速的物理层

#### 以太网的未来

优势：灵活性、简单性、兼容性、廉价、可靠、易维护、易扩展

### 数据链路层交换

#### 数据链路层交换原理

物理层设备扩充网络 => 扩大了冲突域，性能降低，安全隐患!

数据链路层设备扩充网络

- **网桥或交换机**
- 分隔了冲突域

<img src="../images/image-20241024103923745.png" alt="image-20241024103923745" style="zoom:50%;" />

----------------------

理想的网桥是透明的。

- 即插即用，无需任何配置
- 网络中的站点无需感知网桥的存在与否

##### MAC地址表的构建-逆向学习源地地址

**主机向外发送数据时，其MAC地址就会被学习**



MAC地址表的构建

- 增加表项：帧的源地址对应的项不在表中

- 删除表项：**老化时间**到期，默认300s

- 更新表项：帧的源地址在表中，更新时间戳

> [!NOTE]
>
> **MAC地址表会满而溢出吗？是不是存在安全隐患？**
>
> 会，是，因为可以伪造MAC地址，真正有效的站点没办法被转发，被导向到别的站点

##### 网桥对于入境帧的处理过程（forwarding、filtering、flooding）

###### Forwarding（转发）

<img src="../images/image-20241024105113384.png" alt="image-20241024105113384" style="zoom:50%;" />

###### Filtering（过滤）

<img src="../images/image-20241024105132959.png" alt="image-20241024105132959" style="zoom:50%;" />

###### Flooding（泛洪）

<img src="../images/image-20241024105225876.png" alt="image-20241024105225876" style="zoom:50%;" />

两种目的地址的帧，**需要泛洪**：

- **广播帧**：目的地址为`FF-FF-FF-FF-FF-FF`的数据帧
- **未知单播帧**：目的地址不在MAC地址转发表中的单播数据帧

##### 总结

逆向学习

- 根据帧的**源地址**在MAC地址表查找匹配表项，
- 如果没有，则**增加**一个新表项（源地址、入境端口、帧到达时间），
- 如果有，则**更新**原表项的帧到达时间，重置老化时间。

网桥对入境帧的转发过程（三选一），查帧的**目的地址**是否在MAC地址表中

- 如果有，且入境端口≠出境端口，则从对应的出境端口**转发帧**； 
- 如果有，且入境端口=出境端口，则丢弃帧（即**过滤帧**）；
- 如果没有，则向除入境端口以外的其它所有端口**泛洪帧**。

#### 链路层交换机

##### 交换方式

###### 从带宽的角度

- 对称交换：出和入的带宽相同
- 非对称交换：出和入的带宽不同

###### 从转发时机的角度

**存储转发模式**（Store and Forward） 

- 特点：转发前必须接收**整个帧**、执行CRC校验
- 缺点：延迟大
- 优点：不转发出错帧、支持非对称交换

<img src="../images/image-20241024105907162.png" alt="image-20241024105907162" style="zoom:50%;" />

**直通模式**（Cut-through）

- 特点：一旦接收到**帧的目的地址**，就开始转发
- 缺点：可能转发错误帧、不支持非对称交换
- 优点：延迟非常小，可以边入边出

<img src="../images/image-20241024105917949.png" alt="image-20241024105917949" style="zoom:50%;" />

**无碎片模式**（Fragment-free）

- 特点：接收到帧的**前64字节**，即开始转发
- 缺点：仍可能转发错误帧，不支持非对称交换
- 优点：过滤了冲突碎片，延迟和转发错帧介于存储转发和直通交换之间

<img src="../images/image-20241024105956561.png" alt="image-20241024105956561" style="zoom:50%;" />

> [!NOTE]
>
> 小于64字节的帧一定是以太网中冲突导致的

<img src="../images/image-20241024110130021.png" alt="image-20241024110130021" style="zoom:50%;" />

#### 生成树协议

可靠传输：冗余拓扑

付出的代价：导致物理环路

##### 物理环路引发的问题

1. **广播风暴**：交换机（网桥）在物理环路上无休止地泛洪广播流量，无限循环，迅速消耗网络资源
2. **重复帧**：X发送到环路的单播帧，造成目的设备Y收到重复的帧（假设所有交换机的MAC地址表中均没有路由器Y的MAC地址）
3. **MAC地址表不稳定**：当一个帧的多个副本到达不同端口时，交换机会不断修改同一MAC地址对应的端口

##### 生成树网桥

参与的交换机（网桥）：收发桥协议数据单元BPDU

<img src="../images/image-20241024112556684.png" alt="image-20241024112556684" style="zoom:50%;" />

###### 生成树的三个选举过程

(1) 选举**根桥**(Root Bridge)

<img src="../images/image-20241024112854497.png" alt="image-20241024112854497" style="zoom:40%;" />

> [!NOTE]
>
> **如何比较桥ID大小？**
>
> - 首先比较优先级，优先级数值最小的交换机胜出成为根桥。
>
> - 如果优先级数值相等，MAC地址最小的交换机成为根桥。

(2) 为每个非根桥选出一个**根端口**（Root Port）

<img src="../images/image-20241024113139715.png" alt="image-20241024113139715" style="zoom:40%;" />

根路径开销

<img src="../images/image-20241024113235643.png" alt="image-20241024113235643" style="zoom:40%;" />

<img src="../images/image-20241024113445982.png" alt="image-20241024113445982" style="zoom:50%;" />

(3) 为每个网段确定一个**指定端口**（Designated Port）

<img src="../images/image-20241024114010549.png" alt="image-20241024114010549" style="zoom:50%;" />

<img src="../images/image-20241024114400977.png" alt="image-20241024114400977" style="zoom:50%;" />

<img src="../images/image-20241024114343556.png" alt="image-20241024114343556" style="zoom:50%;" />

###### 重构生成树

<img src="../images/image-20241024114713414.png" alt="image-20241024114713414" style="zoom:50%;" />

重新构建生成树太慢了，怎么办？

- **快速生成树协议（Rapid Spanning Tree Protocol, RSTP）** 
- RSTP是STP的优化版，在IEEE802.1W中定义；

#### 虚拟局域网

**广播域（Broadcasting Domain）** 

- 广播域是广播帧能够到达的范围；
- 缺省情况下，交换机所有端口同属于一个广播域，无法隔离广播域； 
- 广播帧在广播域中传播，占用资源，降低性能，且具有安全隐患

<img src="../images/image-20241024115039941.png" alt="image-20241024115039941" style="zoom:50%;" />

--------------------

交换机可以分隔广播域吗？

- 可以！支持VLAN的交换机；
- 一个VLAN（Virtual LAN）是一个独立的广播域；
- 交换机通过划分VLAN，来分隔广播域。

**VLAN**是一个在物理网络上根据用途，工作组、应用等来*逻辑划分*的局域网络，*与用户的物理位置没有关系*。

- 不同VLAN的成员不能直接进行二层通信
- 不同VLAN的成员通信需要通过三层设备

##### VLAN类型

###### 基于端口的VLAN（最常见） 

<img src="../images/image-20241024115555906.png" alt="image-20241024115555906" style="zoom:33%;" />

###### 基于MAC地址的VLAN

<img src="../images/image-20241024115706445.png" alt="image-20241024115706445" style="zoom:33%;" />

###### 基于协议的VLAN

通常需要服务器的参与

###### 基于子网的VLAN

一个子网就是一个VLAN

---------------------

如何区分不同VLAN的数据帧？

- 在数据帧中携带VLAN标记；
- VLAN 标记由交换机添加/剥除，对终端站点透明

**标记帧（Tagged Frame）** 

<img src="../images/image-20241024120021204.png" alt="image-20241024120021204" style="zoom:50%;" />

###### VLAN优点

有效控制广播域范围：广播流量被限制在一个VLAN内；

增强网络的安全性：VLAN间相互隔离,无法进行二层通信,不同VLAN需通过三层设备通信；

灵活构建虚拟工作组：同一工作组的用户不必局限于同一物理范围；

提高网络的可管理性：将不同的业务规划到不同VLAN便于管理

##### Access链路类型端口

##### Trunk链路类型端口与Trunk链路



### 无线局域网

#### 无线局域网概述

**无线局域网（Wireless Local Area Network，WLAN)**：指以无线信道作为传输介质的计算机局域网

#### 无线局域网组网模式

基础架构模式

- 分布式系统（DS） 
- **访问点（AP）** 
- 站点（STA） 
- **基本服务集（BSS）** 
- 扩展服务集（ESS） 
- 站点之间通信通过AP转发

自组织模式（Ad hoc） 

- 站点（STA）
- 独立基本服务集（IBSS）
- 站点之间直接通信
- 共享同一无线信道

##### 无线局域网体系结构



##### 802.11物理层

<img src="../images/image-20241024121425302.png" alt="image-20241024121425302" style="zoom:50%;" />



#### 802.11介质访问控制

传输范围..？

<img src="../images/image-20241024121805095.png" alt="image-20241024121805095" style="zoom:50%;" />

<img src="../images/image-20241024121920372.png" alt="image-20241024121920372" style="zoom:50%;" />

##### CSMA/CA

带有冲突避免的CSMA Carrier Sense Multiple Access with Collision Avoid

- 当信道空闲时间大于IFS（帧间隙），立即传输
- 当信道忙时，延迟直到当前传输结束+IFS时间
- 开始随机退后过程
  - 从（0，CWindow）中选择一个随机数作为退后计数器（backoff counter） 
  - 通过侦听确定每个时间槽是否活动
  - 如果没有活动，则减少退后时间
- ==退后过程中如果信道忙，则挂起退后过程==（解决站点之间的公平问题） 
- 在当前帧传输结束后恢复退后过程

> [!NOTE]
>
> **使用退后过程延迟发送的目的**：避免多个站点同时传输引起的冲突
>
> **CWindow**：竞争窗口

WIFI采用停等机制

<img src="../images/image-20241031100250426.png" alt="image-20241031100250426" style="zoom:33%;" />

- 越短的帧间隙，越能抢到信道

##### RTS-CTS机制（可选机制） 

目的：**通过信道预约，避免长帧冲突**

- 发送端发送RTS（request to send） 

- 接收端回送CTS（clear to send） 
- RTS和CTS中的持续时间（Duration）中指明传输所需时间（数据+控制）
- 其他相关站点能够收到RTS或（和）CTS，维护NAV(Network Allocation Vector)，静默期
- 虚拟载波侦听（Virtual Carrier Sense） 
- RTS和CTS帧很短，即使产生冲突，信道浪费较少

-------------------------------------

如何应对无线链路较高的出错率**？** 

- 解决方法：采用**较小的帧**（将用户数据帧分段的机制对用户透明）





#### 802.11帧结构

<img src="../images/image-20241031101636008.png" alt="image-20241031101636008" style="zoom:33%;" />

<img src="../images/image-20241031101656527.png" alt="image-20241031101656527" style="zoom:33%;" />

#### 无线局域网的构建与管理

<img src="../images/image-20241031101837370.png" alt="image-20241031101837370" style="zoom:33%;" />

**被动扫描**

- AP周期性发送Beacon帧，站点在每个可用的通道上扫描Beacon帧

**主动扫描**

- 站点依次在每个可用的通道上发出包含SSID的Probe Request 帧，具有被请求SSID的AP返回Probe Response帧 

<img src="../images/image-20241031102303959.png" alt="image-20241031102303959" style="zoom:33%;" />

**关联过程**

- 身份认证获得通过后， 进入关联阶段
- 站点向 AP 发送关联请求（Association Request） 
  - 包含：Capability, Listen Interval, SSID, Supported Rates
- AP 向站点返回关联响应（Association Response） 
  - 包含：Capability, Status Code, Station ID, Supported Rates
- AP维护站点关联表，并记录站点的能力（如能够支持的速率等）

<img src="../images/image-20241031102736894.png" alt="image-20241031102736894" style="zoom:33%;" />

**站点睡眠管理**

- 目的：延长电池的续航时间

#### Wi-Fi6 核心技术概览

Wi-Fi 6 (*802.11ax*) 核心目标：解决网络容量和传输效率问题、降低传输时延，相对于 Wi-Fi 5，在高密部署场景中将用户平均吞吐量提升4倍以上，并发用户数提升3倍以上

## 网络层

> [!IMPORTANT]
>
> 目标：

### 网络层服务

#### 网络层服务概述

![]()

网络层实现端系统间的**多跳传输**

网络层功能存在每台主机和路由器中

- 发送端：
- 接收端：
- 路由器：

#### 网络层的关键功能

##### 路由（控制面）

选择数据从源端到接收端

- 核心：



#### 提供给传输层的服务

网络层提供可靠性，面向连接（虚电路）

端系统提供可靠性，面向无连接（数据报）

##### 无连接服务

如寄信

数据报服务

- 4点

尽力而为交付

- 

优点：造价大大降低

##### 连接服务

如打电话

虚电路(virtual circuit)是逻辑链接

面向连接也不一定能保证数据传输的可靠性



![]()



#### 虚电路和数据报网络的性能比较

##### 1.性能角度



##### 2.效率角度



### Internet网际协议

#### IPv4报文格式

<img src="../images/image-20241031110942582.png" alt="image-20241031110942582" style="zoom:33%;" />

<img src="../images/image-20241031111054417.png" alt="image-20241031111054417" style="zoom:33%;" />

##### 数据包分片

MTU（Maximum Transmission Unit）, 最大传输单元

分片策略

- 允许途中分片：根据下一跳链路的MTU实施分片

- 不允许途中分片：发出的数据报长度小于路径MTU（路径MTU发现机制）

重组策略

- 途中重组，实施难度太大

- 目的端重组（互联网采用的策略）

- 重组所需信息：原始数据报编号、分片偏移量、是否收集所有分片

<img src="../images/image-20241031111725581.png" alt="image-20241031111725581" style="zoom:33%;" />

<img src="../images/image-20241031111937627.png" alt="image-20241031111937627" style="zoom:33%;" />

##### IP地址

IP地址，网络上的每一台主机（或路由器）的每一个接口都会分

配一个全球唯一的32位的标识符

:hand: 将IP地址划分为固定的类，每一类都由两个字段组成

:hand: 网络号相同的这块连续IP地址空间称为地址的前缀，或网络前缀

<img src="../images/image-20241031112328743.png" alt="image-20241031112328743" style="zoom:33%;" />

Q

<img src="../images/image-20241031114850271.png" alt="image-20241031114850271" style="zoom:33%;" />

> 

##### 最长前缀匹配

最长前缀匹配（Longest prefix match） 

:hand: CIDR可变长子网掩码以及路由聚合，需要最长前缀匹配来实现最精确匹配

:hand: IP地址与IP前缀匹配时，总是选取==子网掩码最长的匹配项==

<img src="../images/image-20241031115520686.png" style="zoom:33%;" />



<img src="../images/image-20241031115827906.png" alt="image-20241031115827906" style="zoom:33%;" />

##### IPv4地址如何获取

<img src="../images/image-20241031115914570.png" alt="image-20241031115914570" style="zoom:33%;" />

#### DHCP动态主机配置协议

DHCP：**动态主机配置协议**

- 当主机加入IP网络，允许主机从DHCP服务器动态获取IP地址
- 可以有效利用IP地址，方便移动主机的地址获取

工作模式：**客服/服务器模式（C/S）** 

- **基于UDP工作**，服务器运行在67号端口，客户端运行在68号端口

<img src="../images/image-20241031120346786.png" alt="image-20241031120346786" style="zoom:33%;" />

1. DHCP 客户从UDP**端口68**以**广播**形式向服务器发送发现报文（`DHCPDISCOVER`） 

2. DHCP 服务器**单播**发出提供报文（`DHCPOFFER`） 

3. DHCP 客户从多个DHCP服务器中选择一个，并向其以**广播**形式发送DHCP请求报文（`DHCPREQUEST`） 
4. 被选择的DHCP服务器单播发送确认报文（`DHCPACK`）

<img src="../images/image-20241031121548464.png" alt="image-20241031121548464" style="zoom:33%;" />

##### IP 与 MAC地址

#### ARP地址解析协议（Address Resolution Protocol） 

##### IP包转发

直接交付：与目的主机在同一个IP子网内



#### NAT 

网络地址转换(NAT)用于解决IPv4地址不足的问题，是一种将私有（保留）地址转化为公有IP地址的转换技术

内网地址可以重复（在不同内网都是指不同的地址），到外网由NAT边界路由器进行IP地址转换

**私有IP地址（内网地址）**：

- A类地址：10.0.0.0--10.255.255.255

- B类地址：172.16.0.0--172.31.255.555

- C类地址：192.168.0.0--192.168.255.255

##### NAT工作机制

<img src="../images/image-20241107101548196.png" alt="image-20241107101548196" style="zoom:33%;" />

<img src="../images/image-20241107102147921.png" alt="image-20241107102147921" style="zoom:33%;" />

> [!NOTE]
>
> **同一主机不同应用，或者不同主机的同一端口，NAT转换如何处理？**换端口（区分到每台主机的不同应用）

**出数据报**：外出数据报用 NAT IP地址(全局), 新port # 替代 源IP地址(私有), port #

**NAT转换表**：每个 (源IP地址, port #)到(NAT IP地址, 新port #) 映射项

**入数据报**：对每个入数据报的地址字段用存储在NAT表中的(源IP地址, port #)替代对应的 (NAT IP地址, 新port #)

端口号由两个字节（16bit）表示

##### NAT优缺点

NAT的优势

- 节省合法地址，减少地址冲突
- 灵活连接Internet
- 保护局域网的私密性

问题或缺点

- 违反了IP的结构模型，路由器处理传输层协议（三层的路由器看四层的端口）
- 违反了端到端的原则
- 违反了最基本的协议分层规则
- 不能处理IP报头加密
- 新型网络应用的设计者必须要考虑 NAT场景，如 P2P应用程序

外网的client要连内网的host？relaying

<img src="../images/image-20241107103147155.png" alt="image-20241107103147155" style="zoom:33%;" />

#### Internet控制报文协议

ICMP: 互联网控制报文协议

ICMP报文类型

- ICMP 差错报告报文

- 终点不可达：不可达主机、不可达网络，无效端口、协议

- ICMP 询问报文

- 回送请求/回答 (ping使用)

##### PING (Packet InterNet Groper) 

- PING 用来测试两个主机之间的连通性

- PING 使用了 ICMP 回送请求与回送回答报文

- 可以知道 连通性、往返时延、单向转发跳数

##### Traceroute和ICMP

如何知道整个路径上路由器的地址？ 使用TraceRT命令

这个方法不精确：互联网上的路由是独立的

### 路由算法

路由算法须满足的特性：

- 正确性、简单性、鲁棒性、稳定性、公平性、有效性

根据路由算法是否随网络的通信量或拓扑自适应划分

- 静态路由选择策略（非自适应路由选择）
- 动态路由选择策略（自适应路由选择）

#### 优化原则

汇集树(Sink Tree)

- 所有的源节点到一个指定目标节点的最优路径的集合构成一棵以目标节点为根的树
- 一棵路由器B的汇集树（距离度量单位：步长数）

**汇集树不是唯一的**

#### 最短路径算法

Dijkstra算法

#### 距离向量路由

Bellman-Ford 方程

假设Dx(y) 是 从x到y最小代价路径的代价值；其中m为x的邻居, c(x,m)为m到X的距离
$$
Dx(y) = min {c(x,m) + Dm(y) }
$$
**距离向量（Distance Vector）**算法基本思想: 

- 每个节点周期性地向邻居发送它自己到某些节点的距离向量；
- 当节点x接收到来自邻居的新DV估计，它使用B-F方程更新其自己的DV :

上述过程迭代执行，Dx *(y)收敛为实际最小费用* dx(y)

距离向量算法**特点**：迭代的、分布式的

**缺点drawback of DV:** 

- **It reacts rapidly to good news, but leisurely to bad news.**对好消息反应快，坏消息反应慢 
- **It is known as the count-to-infinity problem**

Attempts to solve **Count-to-infinity** problem —— **Poisoned reverse** (毒性逆转, RFC 1058) --> 但不能完全解决这个问题

#### 链路状态路由

链路状态（Link State）路由可分为五个部分：

1. 发现邻居，了解他们的网络地址；

2. 设置到每个邻居的成本度量；

3. 构造一个分组，分组中包含刚收到的所有信息；

4. 将此分组发送给其他的路由器；

5. 计算到其他路由器的最短路径。

<img src="../images/image-20241107115807540.png" alt="image-20241107115807540" style="zoom:33%;" />

#### 层次路由

产生原因：

- 过于庞大的路由表存储、查找困难，路由信息交互开销高
- 为提高路由器查表速度，减少路由表存储空间，需要缩减路由条目
- 可以通过地址聚合进一步缩减路由条目

基本思路:

**互联网由大量不同的网络互连，每个管理机构控制的网络是自治的**

**自治系统**（AS，Autonomous System） 

- 一个管理机构控制之下的网络
- 一个AS内部通常使用相同的路由算法/路由协议，使用统一的路由度量（跳数、带宽、时延 …） 
- 不同的AS可以使用不同的路由算法/路由协议
- 每个AS有一个全球唯一的ID号：AS ID
- 自治系统内的还可以进一步划分层次：私有自治系统或区域

自治系统内部使用内部网关路由协议 Interior Gateway Protocols (IGP)

自治系统之间之间使用外部网关路由协议 Exterior Gateway Protocols (EGP)

<img src="../images/image-20241107122126259.png" alt="image-20241107122126259" style="zoom:33%;" />



#### 广播路由 Broadcasting

广播（Broadcasting）：源主机同时给全部目标地址发送同一个数据包

方法3：**泛洪（flooding）**

- 一种将数据包发送到所有网络节点的简单方法

- 将每个进入数据包发送到除了进入线路外的每条出去线路

- 用途

  - 保证性：一种有效广播手段，可确保数据包被传送到网络中每个节点
  - 鲁棒性：即使大量路由器被损坏，也能找到一条路径（如果存在）
  - 简单性：仅需知道自己的邻居

- 无控制的泛洪：*环路*可能导致广播风暴

- 解决方法：受控制的泛洪（每个路由器进行有选择的泛洪）

  - 序号控制泛洪（sequence-number-controlled flooding） 
    - 记录每个来源的广播序号
    - <img src="../images/image-20241114100855009.png" alt="image-20241114100855009" style="zoom:33%;" />
  - 逆向路径转发（reverse path forwarding, RPF） 
    - <img src="../images/image-20241114100921015.png" alt="image-20241114100921015" style="zoom:33%;" />

  <img src="../images/image-20241114101745045.png" alt="image-20241114101745045" style="zoom:33%;" />

方法4：**生成树（spanning tree）**

- 源节点向所有属于该生成树的特定链路发送分组
- 改进了逆向路径转发
- 没有环路
- 最佳使用带宽
- 最少副本，消除了冗余分组
- 一个路由器可以不必知道整颗树，只需要知道在一颗树中的邻居即可

#### 组播路由 multicasting

组播（multicasting）：源主机给网络中的一部分目标用户发送数据包

组播实现的两个步骤：

1. 确定组成员
2. 生成树——路由器与路由器之间的协议

- 最佳生成树的使用取决于组的密度分布

  - 密集分布，基于源点树（source-based trees） 

    <img src="../images/image-20241114102551036.png" alt="image-20241114102551036" style="zoom:33%;" />

    - 存在的问题：
      - 大型网络中，组播源很多时，路由器需生成多颗棵树，工作量巨大
      - 路由器需要大量空间来存储多颗树

  - 稀疏分布，基于核心树（core-based trees） 

    <img src="../images/image-20241114102709672.png" alt="image-20241114102709672" style="zoom:33%;" />

    - 基于核心树（core-based trees）存在的问题：
      - 可能无法达到最优
      - 如果只有一个发送者，将发送者作为核心是最优的

**IGMP (Internet Group Management Protocol)**：路由器获悉该网段的组播组成员

常用组播地址段：224.0.0.0/24

<img src="../images/image-20241114102242154.png" alt="image-20241114102242154" style="zoom:33%;" />



#### 选播路由 Anycast

选播（Anycast） 

- 将数据包传送给最近的一个组成员
- 在有多个服务器的情况下，用户希望快速获得正确信息，而不在乎从哪个服务器获得

<img src="../images/image-20241114103115444.png" alt="image-20241114103115444" style="zoom:33%;" />

选播的典型应用：DNS

- 在没有指定DNS服务器的情况下，用户将始终连接到“最接近”(从路由协议角度来看) 服务器，可以减少延迟，并提供一定程度的负载平衡

### Internet路由协议

#### OPSF-内部网关路由协议

OSPF（Open Shortest Path First）采用**分布式的链路状态**算法

OSPF协议的基本思想

- 向本*自治系统*中所有路由器洪泛信息
- 发送的信息就是与本路由器相邻的所有路由器的链路状态
- 只有当*链路状态*发生变化时路由器才用洪泛法发送此信息

##### OSPF-链路状态

“链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)

- OSPF度量值一般包括费用、距离、时延、带宽等

所有的路由器最终都能建立一个*链路状态数据库LSDB*

##### OSPF-区域的概念

OSPF支持将一组网段组合在一起，称为一个区域

使用层次结构的区域划分，上层的区域叫做**主干区域(backbone area)**，其他区域都必须与主干区域相连

非主干区域之间不允许直接发布区域间路由信息

<img src="../images/image-20241114104229921.png" alt="image-20241114104229921" style="zoom:40%;" />

##### 小结

<img src="../images/image-20241114104450190.png" alt="image-20241114104450190" style="zoom:40%;" />

#### RIP-内部网关路由协议

**路由选择协议RIP（ Routing Information Protocol）**是基于[距离矢量算法](# 距离向量路由)的协议

使用**跳数**衡量到达目的网络的距离

- RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短” 
- RIP 允许一条路径最多只能包含 15 个路由器

RIP协议的基本思想

- 仅和相邻路由器交换信息（交换DV）
- 路由器交换的内容是自己的路由表
- 周期性更新：30s

##### 小结

<img src="../images/image-20241114105310291.png" alt="image-20241114105310291" style="zoom:33%;" />

#### BGP-外部网关路由协议

> [!NOTE]
>
> 路由协议：
>
> 内部网关协议 IGP： 有 RIP 和、OSPF、ISIS 等多种具体的协议
>
> 外部网关协议 EGP：目前使用的协议就是 BGP

**边界网关协议BGP (Border Gateway Protocol)** ：目前互联网中唯一实际运行的自治域AS间的路由协议

BGP功能

- eBGP：从相邻的AS获得网络可达信息
- iBGP： 将网络可达信息传播给AS内的路由器
- 基于网络可达信息和策略决定到其他网络的“最优”路由

<img src="../images/image-20241114105911720.png" alt="image-20241114105911720" style="zoom:33%;" />

**BGP会话**: 两个BGP路由器通过TCP连接交换BGP报文

- 通告到不同网络前缀的路径，即**路径向量**协议

**BGP路径通告**：完整路径通报给AS

<img src="../images/image-20241114110331336.png" alt="image-20241114110331336" style="zoom:33%;" />

路由器可能会学到多条到目的网络的路径

由策略，AS1路由器1c可能选择路径 AS3, X, 并在AS1中通过iBGP通告路径

##### BGP协议的特点

BGP 协议交换路由信息的结点数量级是自治系统数的量级

每一个自治系统边界路由器的数目是很少的

在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表；以后只需要在发生变化时更新有变化的部分

##### BGP报文

BGP通过TCP的179端口交换报文

##### BGP路由策略

路由器使用策略决定接受或拒绝接收到的路由通告

路由器也会基于策略决定是否向其他相邻AS通告路径信息

#### 标签交换和MPLS

**MPLS (MultiProtocol Label Switching) 多协议标签交换**

- 多协议表示在 MPLS 的上层可以采用多种协议，例如：IP，IPv6、IPX
- 标签是指每个分组被分配一个标签，路由器根据该标签对分组进行转发
- 交换是指标签的交换，MPLS 报文交换和转发是基于标签的

MPLS 设计初衷为了*提升查找速度*

MPLS 主要有以下三个方面的应用

- 面向连接的服务质量管理
- 流量工程，平衡网络负载
- 虚拟专用网VPN

**标签交换路由器LSR**

- 支持MPLS的路由器
- 具备标签交换、路由选择两种功能

MPLS 域 

- 所有相邻的支持MPLS技术的路由器构成的区域

标签分配协议LDP

- 用来在LSR之间建立LDP 会话并交换Label/FEC映射信息

##### 工作过程

<img src="../images/image-20241114112540755.png" alt="image-20241114112540755" style="zoom:50%;" />

### 路由器工作原理

路由器是互联网最主要的网络设备，包含2个核心功能

- 控制层：运行各种路由协议：BGP、OSPF、RIP，学习去往不同目的的转发路径：路由表
- 数据层：根据上述路由表，将收到的IP分组转发到正确的下一跳链路

#### 控制层

路由器可同时运行多个路由协议

路由器也可不运行任何路由协议，只使用静态路由和直连路由

路由管理根据路由优先级，选择最佳路由，形成核心路由表

控制层将核心路由表下发到数据层，形成转发表（FIB）

- 若存在多个“去往同一目的IP前缀”的不同类型路由，路由器根据优先级选择最佳路由
  - 优先级数值越小，优先级越高
  - <img src="../images/image-20241114112803318.png" alt="image-20241114112803318" style="zoom:33%;" />

#### 数据层

<img src="../images/image-20241114112938001.png" alt="image-20241114112938001" style="zoom:40%;" />

### 拥塞控制算法

> [!TIP]
>
> 具体见下一章

#### 拥塞控制概述

拥塞：网络中存在太多的数据包导致数据包传输延迟或丢失，从而导致网络吞吐量下降

拥塞控制（congestion control）：需要确保通信子网能够承载用户提交的通信量，是一个全局性问题，涉及主机、路由器等多种因素

产生拥塞的原因：

- 主机发送到网络的数据包数量过多，超过了网络的承载能力
- 突发的流量填满了路由器的缓冲区，造成某些数据包会被丢弃

拥塞可以在网络层解决，但实际上大多在传输层解决

#### 流量感知路由



#### 流量调节

显式拥塞通告（ECN，Explicit Congestion Notification）

#### 随机早期检测

### 服务质量

> [!TIP]
>
> 不是很重要

**网络服务质量（QoS）**

**区分服务（DiffServ：Differentiated services）**

### 三层交换与VPN

#### 三层交换



#### VPN技术

**虚拟专用网VPN (Virtual Private Network)**：利用公用网络架设专用网络的远程访问技术

- 专用网络的经济、可靠、灵活的解决方案
- 利用安全隧道技术将专用网络在公共网络上扩展

VPN的设计原则

- 安全性、隧道与加密、数据验证、用户验证、防火墙与攻击检测

##### VPN的原理

通过隧道技术在公共网络上模拟出一条点到点的逻辑专线，从而达到安全数据传输的目的

### IPv6技术

初始动机：应付“32-bit地址空间耗尽”问题（CIDR和NAT都无法从根本上解决地址短缺问题），增加地址空间

<img src="../images/image-20241114114800138.png" alt="image-20241114114800138" style="zoom:50%;" />

#### IPV6 头部

<img src="../images/image-20241114115641311.png" alt="image-20241114115641311" style="zoom: 33%;" />

<img src="../images/image-20241114115658061.png" alt="image-20241114115658061" style="zoom:33%;" />

**IPv6头部字段分析**

<img src="../images/image-20241114115736513.png" alt="image-20241114115736513" style="zoom:33%;" />

#### IPv6扩展头

<img src="../images/image-20241114115917551.png" alt="image-20241114115917551" style="zoom:33%;" />

#### 邻居发现

不展开

#### IPv6地址及配置

<img src="../images/image-20241114120240881.png" alt="image-20241114120240881" style="zoom:33%;" />

#### IPv4到IPv6迁移及过渡技术

主流过渡技术：双栈技术、翻译技术、隧道技术

##### 隧道技术

隧道技术（2个同构网络的系统，跨越中间异构网络进行通信）：将A协议数据包封装在B协议中传输

<img src="../images/image-20241114121200236.png" alt="image-20241114121200236" style="zoom:33%;" />

##### 翻译技术

破坏互联网端到端原则

## 传输层

### 概述和传输层服务

#### 传输层的位置

传输层位于应用层和网络层之间

“端到端”设计原则：应用程序只运行在终端上，进程 -- 进程

传输层应提供进程之间本地通信的抽象

#### 不同终端上的进程如何通信？

应用程序和网络之间存在一扇“门”：这扇“门”称为**套接字（socket）**，是应用层和传输层的接口，也是应用程序和网络之间的API

#### 传输层提供什么服务？

**网络层**提供“尽力而为”的服务 Best effort

- 不保证交付，不保证按序交付，不保证数据完整，不保证延迟，不保证带宽等

传输层的**有所为**、**有所不为**

- 传输层可以通过差错恢复、重排序等手段提供可靠、按序的交付服务
- 但传输层无法提供延迟保证、带宽保证等服务

<img src="../images/image-20241121101238998.png" alt="image-20241121101238998" style="zoom: 33%;" />

### 套接字编程

#### 网络应用

应用程序体系结构：客户-服务器体系结构（C/S） client-server

客户只与服务器通信，客户之间不通信

#### 进程如何标识自己

进程标识包括： 

- 主机地址

- 主机上与该进程关联的端口号 port number

#### 应用编程接口：socket API

应用需**显式地**创建、使用和释放套接字

采用客户-服务器模式：客户总是主动发起通信的一方，服务器始终在等待客户的服务请求到来

应用可以通过socket API调用两种传输服务: 

- 不可靠的数据报服务：由UDP协议实现
- 可靠的字节流服务：由TCP协议实现

#### 创建套接字：socket()

<img src="../images/image-20241121101815974.png" alt="image-20241121101815974" style="zoom:33%;" />

#### 套接字描述符

<img src="../images/image-20241121101912511.png" alt="image-20241121101912511" style="zoom:33%;" />

#### 使用UDP套接字实现回音服务

客户或服务器调用sendto()发送数据

客户或服务器调用recvfrom()接收数据

##### 通信流程

<img src="../images/image-20241121102356020.png" alt="image-20241121102356020" style="zoom:33%;" />

```c
// UDP服务端代码
int main(int argc, char **argv){
    char mesg[MAXLINE];
    int sockfd, n, len;
    struct sockaddr_in cliaddr, servaddr;
    
    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    bzero(&servaddr, sizeof(servaddr));
    servaddr.sin_family = AF_INET;
    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
    servaddr.sin_port = htons(SERV_PORT);
    
    bind(sockfd, (struct sockaddr *) &servaddr, sizeof(servaddr));
    
    for ( ; ; ) {
        len = sizeof(cliaddr);
        n = recvfrom(sockfd, mesg, MAXLINE, 0, cliaddr, &len);
        sendto(sockfd, mesg, n, 0, cliaddr, len); 
    }
}

// UDP 回音 客户端代码
int main(int argc, char **argv){
    int sockfd, n;
    struct sockaddr_in servaddr;
    char sendline[MAXLINE], recvline[MAXLINE + 1]; 
    if (argc != 2){
        fprintf(stderr, %s\n, "usage: echoCli <IPaddress>");
        exit(EXIT_FAILURE);
    }
    sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    bzero(&servaddr, sizeof(servaddr));
    servaddr.sin_family = AF_INET; 
    inet_pton(AF_INET, argv[1], &servaddr.sin_addr);
    servaddr.sin_port = htons(SERV_PORT);
    while (fgets(sendline, MAXLINE, stdin) != NULL) { 
        sendto(sockfd, sendline, strlen(sendline), 0, 
               (struct sockaddr *)servaddr, sizeof(servaddr));
        n = recvfrom(sockfd, recvline, MAXLINE, 0, NULL, NULL);
        recvline[n] = 0;
        fputs(recvline, stdout);
    } 
    exit(0);
}
```

#### 使用TCP套接字实现回音服务

TCP服务器监听套接字：listen() -- 服务端

TCP套接字系统调用：accept() -- 服务端

TCP套接字系统调用：connect() -- 客户端

服务端在SERV_PORT（9999）监听

##### 服务器使用多个套接字服务客户

1. 服务器进程在**监听套接字**上等待客户的连接请求
2. 客户进程创建一个*本地套接字*，与服务器的监听套接字通信： 在此过程中，客户TCP向服务器TCP发送连接请求
3. 收到连接请求后，服务器进程创建一个**临时套接字（连接套接字）**和一个新的服务器进程，与客户进程通信
4. 服务器进程回到监听套接字上继续等待：此举允许服务器同时服务多个客户
5. 客户服务结束后，服务器销毁进程，关闭连接套接字

##### 基于TCP的套接字通信流程

<img src="../images/image-20241121103558076.png" alt="image-20241121103558076" style="zoom:33%;" />

```c
// TCP回音服务端
int main(int argc, char **argv){
    int listenfd, connfd;
    socklen_t clilen;
    struct sockaddr_in cliaddr, servaddr;
    
    listenfd = socket(AF_INET, SOCK_STREAM, 0);
    bzero(&servaddr, sizeof(servaddr));
    servaddr.sin_family = AF_INET;
    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);
    servaddr.sin_port = htons(SERV_PORT);
    bind(listenfd, (struct sockaddr *) &servaddr, sizeof(servaddr));
    listen(listenfd, LISTENQ);
    
    for ( ; ; ) {
        clilen = sizeof(cliaddr);
        connfd = accept(listenfd, (struct sockaddr *) &cliaddr, &clilen);
        str_echo(connfd); /* process the request */
    }
}


```

#### 套接字标识与端口号

端口号是套接字标识的一部分：

- 每个套接字在本地关联一个端口号

- 端口号是一个16比特的数

:hand:端口号的分类：

- 熟知端口：0～1023，由公共域协议使用

- 注册端口：1024～49151，需要向IANA注册才能使用

- 动态和/或私有端口：49152～65535，一般程序使用

:hand:报文段中有两个字段携带端口号

- 源端口号：与发送进程关联的本地端口号

- 目的端口号：与接收进程关联的本地端口号

##### 套接字端口号的分配

自动分配（客户端）：

- 创建套接字时不指定端口号
- 由操作系统从49152～65535中分配

使用指定端口号创建套接字（服务器）：

- 创建套接字时指定端口号
- 实现公共域协议的服务器应分配众所周知的端口号（0～1023） 



### 传输层复用和分用

传输层基本服务：将主机间交付扩展到进程间交付，通过**复用**和**分用**实现

- （发送端）复用：传输层从多个套接字收集数据，交给网络层发送
- （接收方）分用：传输层将从网络层收到的数据，交付给正确的套接字

#### UDP套接字

UDP套接字使用`<IP地址, 端口号>`二元组进行标识

接收方传输层收到一个UDP报文段后：

- 检查报文段中的目的端口号，将UDP报文段交付到具有该端口号的套接字

- <目的IP地址，目的端口号> 相同的UDP报文段被交付给同一个套接字，与 <源IP地址，源端口号> 无关

- 报文段中的 <源IP地址，源端口号> 被接收进程用来发送响应报文

#### TCP套接字

一个TCP服务器为了同时服务很多个客户，使用两种套接字

监听套接字：

- 服务器平时在监听套接字上等待客户的连接请求，该套接字具有众所周知的端口号

连接套接字：

- 服务器在收到客户的连接请求后，创建一个连接套接字，使用临时分配的端口号

- 服务器同时创建一个新的进程，在该连接套接字上服务该客户
- **每个连接套接字只与一个客户通信**，即只接收具有以下四元组的报文段：
  - 源IP地址 = 客户IP地址，源端口号 = 客户套接字端口号
  - 目的IP地址 = 服务器IP地址，目的端口号 = 服务器监听套接字的端口号

连接套接字需要使用`<源IP地址，目的IP地址，源端口号，目的端口号>`**四元组**进行标识，服务器使用该四元组将TCP报文段交付到正确的连接套接字

### 无连接传输：UDP

UDP提供的服务：

- 进程到进程之间的报文交付

- 报文完整性检查（可选）：检测并丢弃出错的报文

:hand:UDP需要实现的功能：

- 复用和分用

- 报文检错

#### UDP报文段结构

<img src="../images/image-20241121105714048.png" alt="image-20241121105714048" style="zoom:33%;" />

#### 校验和计算

<img src="../images/image-20241121110110364.png" alt="image-20241121110110364" style="zoom:33%;" />

#### 为什么需要UDP？

1. 为什么需要UDP？ 

应用可以尽可能快地发送报文：

- 无建立连接的延迟
- 不限制发送速率（不进行拥塞控制和流量控制）
- 报头开销小
- 协议处理简单

2. UDP适合哪些应用？

- 容忍丢包但对延迟敏感的应用：如流媒体
- 以单次请求/响应为主的应用：如DNS
- 若应用要求基于UDP进行可靠传输： 由应用层实现可靠性



### 面向连接的传输：TCP

#### TCP概述

TCP服务模型： 在一对通信的进程之间提供一条理想的**字节流管道**

点到点通信: 仅涉及一对通信进程

全双工：可以同时双向传输数据

可靠、有序的字节流：**不保留报文边界**

**需要的机制：**

1. 建立连接: 通信双方为本次通信建立数据传输所需的状态（套接字、缓存、变量等）
2. 可靠数据传输：流水线式发送，报文段检错，丢失重传
3. 流量控制: 发送方不会令接收方缓存溢出

#### TCP报文段结构

<img src="../images/image-20241121112208877.png" alt="image-20241121112208877" style="zoom:33%;" />

**发送序号 seq number**：数据载荷中第一个字节在字节流中的序号

**确认序号 ack number**：期望接收的下一个字节的序号

**最大段长度（MSS）**：TCP段中可以携带的最大数据字节数; 建立连接时，每个主机可声明自己能够接受的MSS，缺省为536字节

<img src="../images/image-20241121112530950.png" alt="image-20241121112530950" style="zoom:50%;" />

#### TCP可靠数据传输

TCP 在不可靠的IP服务上建立可靠的数据传输

:sheep:基本机制

- 发送端：流水线式发送数据、等待确认、超时重传
- 接收端：进行差错检测，采用累积确认机制

:sheep:乱序段处理：协议没有明确规定

- 接收端不缓存：可以正常工作，处理简单，但效率低
- 接收端缓存：效率高，但处理复杂

##### 高度简化的TCP协议

**仅考虑可靠传输机制，且数据仅在一个方向上传输**

<img src="../images/image-20241121113415248.png" alt="image-20241121113415248" style="zoom:40%;" />

##### TCP发送方要处理的事件

:hand:收到应用数据：

- 创建并发送TCP报文段

- 若当前没有定时器在运行（没有已发送、未确认的报文段），启动定时器

:hand:超时: 

- 重传包含最小序号的、未确认的报文段

- 重启定时器

:hand:收到ACK： 

- 如果确认序号大于基序号（已发送未确认的最小序号）：
- 推进发送窗口（更新基序号）
- 如果发送窗口中还有未确认的报文段，启动定时器，否则终止定时器

##### 如何设置超时值

SampleRTT：瞬时 从发出某个报文段到收到其确认报文段之间经过的时间

EstimatedRTT：平均值​​

平均RTT的估算方法（指数加权移动平均）：

- EstimatedRTT = (1- α):heavy_multiplication_x:EstimatedRTT + α:heavy_multiplication_x:SampleRTT，典型地，α = 0.125 !
- 如果α比较大，则是

##### TCP确认的二义性

重传的TCP报文段使用与原报文段相同的序号

发送端收到确认后 ，无法得知是对哪个报文段进行的确认

解决方法：定时器补偿

- 发送方每重传一个报文段，就直接将超时值增大一倍（不依赖于RTT的更新）
- 若连续发生超时事件，超时值呈指数增长（至一个设定的上限值）



##### 小结

<img src="../images/image-20241121115947561.png" alt="image-20241121115947561" style="zoom:50%;" />

##### TCP使用GBN还是SR

**TCP结合了GBN和SR的优点**

TCP在减小定时器开销和重传开销方面要优于GBN 和 SR！

##### Crash Recovery



#### TCP流量控制

TCP接收端有一个接收缓存：



> [!NOTE]
>
> 本质：发送端TCP通过调节发送速率，不使接收端缓存溢出

##### TCP如何进行流量控制

接收缓存中的可用空间称为**接收窗口**

:hand:

#### TCP连接管理

##### TCP两次次握手建立连接

建立一条TCP连接需要确定两件事：

- 双方都同意建立连接（知晓另一方想建立连接） 
- 初始化连接参数（序号，MSS等）

> [!CAUTION]
>
> **在网络中，2次握手总是可行的吗？**
> 在一个不可靠的网络中，总会有一些意外发生：
> • 包传输延迟变化很大
> • 存在重传的报文段
> • 存在报文重排序
>
> ==> delayed duplicates problem

<img src="../images/image-20241128101520034.png" alt="image-20241128101520034" style="zoom: 33%;" />

Solution 1

Problems
There are two problems which complicates the scenario:
• Possible wrap around of seqno
• Client/Host or Server may crash
Assume seqno = 0,1,…,7 (i.e. 3 bits)

Problem: How to differentiate <span style="color:#CC0000;">delay duplicate</span> and <span style="color:#336600;">new pkt with wrapped around seqno</span>? 

Idea: use time 

Two assumptions that simplifies the problem
• Assumption 1. Time for seqno wrap around (**T1**) is typically large if, e.g., seqno is 32 bits long. 
• Assumption 2. If pkt delays a relatively short time (**T2<T1**), we can use time to differentiate the two.

Solution 2

##### How to realize the assumptions?

**1. Restrict packet lifetime**

Packet lifetime can be restricted to a known maximum using one of the following techniques 

• Restricted subnet design. 

• Putting a hop counter in each packet. 

• Timestamping each packet (router synchronization required)

**T** = *n* * (pkt lifetime)

• It is impossible to receive a delay duplicate after **T**

**2. use time-of-day clock**

- Time-of-day clock at hosts

Each clock is assumed to take the form of a binary counter that increments itself at uniform intervals. 时钟不断增加

The number of bits in the counter must equal or exceed the number of bits in the sequence numbers.

The clock is assumed to continue running even if the host goes down. 

The clocks at different hosts need **not** be synchronized.

- initial seqno of a connection = low k bits of time-of-day clock

##### TCP起始序号的选择

基于时钟的起始序号选取算法：
• 每个主机使用一个时钟，以二进制计数器的形式工作，每隔ΔT时间计数器加1 

• 新建一个连接时，以本地计数器值的最低32位作为起始序号
• 该方法确保连接的起始序号随时间单调增长
ΔT取较小的值（4微秒）：确保发送序号的增长速度，不会超过起始序号的增长速度

使用较长的字节序号（32位）： 确保序号回绕的时间远大于分组在网络中的最长寿命

##### Forbidden region of seqno

<img src="../images/image-20241128102832279.png" alt="image-20241128102832279" style="zoom:50%;" />

<img src="../images/image-20241128103527044.png" alt="image-20241128103527044" style="zoom:33%;" />

The increments of seqno cannot be **too fast or too slow**

Solution for the delayed duplicates：

1. the maximum data rate on any connection is one segment per clock tick. (i.e., cannot be too fast)
2. limits how slowly sequence numbers can advance on a connection (or how long the connections may last). (i.e., cannot be too slow)

##### TCP三次握手建立连接

<img src="../images/image-20241128103834658.png" alt="image-20241128103834658" style="zoom: 33%;" />

<img src="../images/image-20241128105458546.png" alt="image-20241128105458546" style="zoom:50%;" />

##### 关闭TCP连接

Asymmetric release 非对称

- When one part hangs up, the connection is broken. 
- Asymmetric release is abrupt and may result in data loss

Symmetric release 对称

- to treat the connection as two separate unidirectional connections and require each one to be released separately.

SYMMETRIC

<img src="../images/image-20241128104959324.png" alt="image-20241128104959324" style="zoom: 50%;" />

**Two army-problem**：A white army is encamped in a valley. On both of the surrounding hillsides are blue armies. 

##### 客户/服务器经历的TCP状态序列

<img src="../images/image-20241128105703887.png" alt="image-20241128105703887" style="zoom:50%;" />

##### SYN洪泛攻击

攻击者采用伪造的源IP地址，向服务器发送大量的SYN段，却不发送ACK段

服务器为维护一个巨大的半连接表耗尽资源，导致无法处理正常客户的连接请求，表现为服务器停止服务

##### TCP端口扫描

TCP端口扫描的原理：
• 扫描程序依次与目标机器的各个端口建立TCP连接
• 根据获得的响应来收集目标机器信息

在典型的TCP端口扫描过程中，发送端向目标端口发送SYN报文段： 

• 若收到SYNACK段，表明目标端口上有服务在运行
• 若收到RST段，表明目标端口上没有服务在运行
• 若什么也没收到，表明路径上有防火墙，有些防火墙会丢弃来自外网的SYN报文段

### 理解网络拥塞

#### 网络拥塞的后果

网络拥塞造成：
• 丢包：由路由器缓存溢出造成
• 分组延迟增大：链路接近满载造成
大量网络资源用于：
• 重传丢失的分组
• （不必要地）重传延迟过大的分组
• 转发最终被丢弃的分组

结果：进入网络的负载很重，网络吞吐量却很低

#### 拥塞控制的常用方法

端到端拥塞控制
• 网络层不向端系统提供反馈
• 端系统通过观察丢包和延迟，自行推断拥塞的发生
• TCP采用此类方法



### TCP拥塞控制

#### 拥塞检测和速率限制

<span style="color:#CC0000;">发送方如何感知拥塞?</span>

发送方利用丢包事件感知拥塞： • 拥塞造成丢包和分组延迟增大
• 无论是丢包还是分组延迟过大，对
于发送端来说都是丢包了 丢包事件包括：
• 重传定时器超时
• 发送端收到3个重复的ACK

<span style="color:#CC0000;">发送方采用什么机制限制发送速率？</span>

发送方使用**拥塞窗口cwnd**限制已发 送未确认的数据量：LastByteSent-LastByteAcked ≤ cwnd 

$rate = \frac{cwnd}{RTT} \text{Bytes/sec}$

cwnd随发送方感知的网络拥塞程度而变化

#### 拥塞窗口的调节策略：AIMD

Multiplicative Decrease & Additive Increase

<img src="../images/image-20241128112144283.png" alt="image-20241128112144283" style="zoom:50%;" />

#### TCP慢启动

在新建的连接（或沉寂了一段时间的连接）上，以什么速率发送数据（此时接收窗口达最大值）? 

早期的TCP协议：
• 发送端仅以接收窗口大小限制发送速率，网络经常因为拥塞而崩溃！

采用“加性增”增大发送窗口，太慢！
• 在新建连接上，令cwnd = 1 MSS，起始速度= MSS/RTT
• 然而，网络中的可用带宽可能远大于MSS/RTT 

**慢启动**的基本思想：
• 在新建连接上指数增大cwnd，直至检测到丢包（此时终止慢启动）
• 希望迅速增大cwnd至可用的发送速度

--------------

慢启动的策略：每经过一个RTT，将cwnd加倍

慢启动的具体实施：
• **每收到一个ACK段，cwnd增加一个MSS**
• 只要发送窗口允许，发送端可以立即发送下一个报文段

特点：以一个很低的速率开始，按指数增大发送速率

慢启动比谁“慢”？与早期TCP按接收窗口发送数据的策略相比，采用慢启动后发送速率的增长较慢

#### 区分不同的丢包事件

<img src="../images/image-20241128112853377.png" alt="image-20241128112853377" style="zoom:50%;" />

#### TCP拥塞控制的实现

发送方维护变量ssthresh 
发生丢包时，ssthresh=cwnd/2

**ssthresh是从慢启动转为拥塞避免的分水岭**：

- cwnd低于门限时，执行慢启动
- cwnd高于门限：执行拥塞避免

拥塞避免阶段，拥塞窗口线性增长：每当收到ACK， cwnd=cwnd + MSS*(MSS/cwnd)

检测到3个重复的ACK后：

- TCP Reno实现： cwnd= ssthresh+3，线性增长
- TCP Tahoe实现：cwnd=1✖MSS，慢启动

<img src="../images/image-20241128113502853.png" alt="image-20241128113502853" style="zoom:33%;" />

#### TCP发送端的事件与动作

<img src="../images/image-20241128113715827.png" alt="image-20241128113715827" style="zoom:50%;" />

#### Wireless Issues

linker layer重传 速度快于TCP的反应

#### TCP连接的吞吐量

<img src="../images/image-20241128114412311.png" alt="image-20241128114412311" style="zoom:50%;" />

#### TCP的公平性

公平性目标: 如果K条TCP连接共享某条带宽为R的瓶颈链路，每条连接应具有平均速度R/K

<img src="../images/image-20241128115004736.png" alt="image-20241128115004736" style="zoom:50%;" />



### 拥塞控制的发展

#### TCP CUBIC

拥塞控制算法

##### 经典TCP拥塞控制的性能问题

TCP Reno线性增大拥塞窗口，探测当前可用网络带宽，即每经过一个RTT，拥塞窗口增加一个MSS；当端到端时延带宽乘积（BDP）较大时，拥塞窗口增长过慢，导致信道无法满载

<img src="../images/image-20241205100447852.png" alt="image-20241205100447852" style="zoom:50%;" />

##### TCP-BIC

**TCP-BIC**: Binary Increase Congestion

BIC算法对满载窗口进行二分查找：

• 如发生丢包时窗口大小是*W*1，为保持满载而不丢包，满载窗口应小于*W*1 

• 如检测到丢包并将窗口乘性减小为*W*2 ，则满载窗口应大于*W*2 

窗口更新受ACK时钟驱动，即以RTT为更新间隔时间

二分查找: 

• 在ACK时钟的驱动下，将拥塞窗口置为(*W*1 + *W*2)/2(新的*W*2值)，不断逼近满载窗口

最大探查: 

• 如窗口再次达到*W*1而没有丢包，说明满载窗口大于*W*1 ，则以逼近*W*1的镜像过程增大拥塞窗口

<img src="../images/image-20241205100545655.png" alt="image-20241205100545655" style="zoom:50%;" />

BIC存在带宽**不公平性问题**：BIC以ACK时钟驱动拥塞窗口的更新，RTT较短的连接会更快到达满载窗口，占据

更多的带宽，产生不公平性问题（RTT-fairness）

##### TCP CUBIC

CUBIC将BIC算法连续化，用三次函数拟合BIC算法曲线

拥塞窗口成为距上次丢包的时间*t* 的函数，*t* 取值位于两次丢包之间，不再根据RTT间隔来确定调整窗口的时机，**避免了RTT不公平问题**

<img src="../images/image-20241205100721189.png" alt="image-20241205100721189" style="zoom:50%;" />

#### Google BBR

##### 拥塞与瓶颈链路带宽

<img src="../images/image-20241205101159820.png" alt="image-20241205101159820" style="zoom:50%;" />

**BBR**: Bottleneck Bandwidth and Round-trip propagation time

瓶颈链路带宽BtlBw：不会引起路由器缓存排队的最大发送速率
RTprop：往返时间
BDP=BtlBw x RTprop

##### 优化点的近似观测

用过去10秒内的最小RTT（min RTT）和最大投递率（max BW），分别近似RTprop和BtlBw，并依据这两个值估算当前BDP

<img src="../images/image-20241205101516975.png" alt="image-20241205101516975" style="zoom:50%;" />

> [!CAUTION]
>
> Max BW和min RTT不能同时被测得！

<img src="../images/image-20241205101638431.png" alt="image-20241205101638431" style="zoom:50%;" />

##### BDP检测阶段

**启动阶段（START_UP）**

当连接建立时，类似TCP的慢启动，指数增加发送速率，尽可能快地占满管道

若经过三次发现投递率不再增长，说明已达到BtlBw，瓶颈链路处分组已开始排队（事实上此时占的是三倍BDP）

**排空阶段（DRAIN）**

指数降低发送速率（相当于是startup的逆过程），将多占的两倍buffer慢慢排空

**瓶颈带宽探测（PROBE_BW）**

<img src="../images/image-20241205102010135.png" alt="image-20241205102010135" style="zoom:50%;" />

**时延探测（PROBE_RTT）**

<img src="../images/image-20241205102025072.png" alt="image-20241205102025072" style="zoom:50%;" />

#### Data Center TCP

数据中心内部有一类经典的通信模式-**Partition/Aggregate**

- Aggregator将上层应用任务划分给下层的worker执行

##### 数据中心的性能问题

Incast：在一个很短的时间内，大量流量同时到达交换机的一个端口，导致缓冲区被占满，最终导致丢包

 Queue Buildup：

 Buffer Pressure：

##### 需要什么样的传输层协议

容忍高突发流量

• 在Partition/Aggregate通信模式中，所有Worker几乎会在同一时间向

Aggregator返回执行结果，产生很高的突发流量

低时延

• 数据中心有大量时延敏感的短流，如网页搜索等

高吞吐

• 数据中心有大量吞吐敏感的长流，如文件传输、分布式机器学习中神经

网络模型参数的传输等

##### DCTCP核心思想

根据网络拥塞程度精细地减小发送窗口



容忍高突发流量

• DCTCP维持了较低的队列长度，可以留出较大的缓冲区给突发流量

• 采用激进的标记策略，使得发送端在丢包之前就感知到拥塞

低时延

• 由于队列长度较短，也减少了包在队列中的排队时延

高吞吐

• DCTCP根据拥塞程度精确调节窗口，使得发送窗口的变化比较平滑，不

会出现吞吐量骤降的情形

#### DCCP

DCCP=UDP+拥塞控制

- DCCP提供不可靠数据报流服务： 
  - UDP报文段可能丢失、乱序到达
  - 无流量控制
- DCCP提供模块化的拥塞控制： 
  - 应用可以根据需要，选择不同的拥塞控制机制



### 传输层协议的发展

#### MPTCP

传统TCP协议仅支持单路径传输，即只能利用终端主机上的一个网络接口传输数据

##### MPTCP的优势

多径带宽聚合

• 终端设备可以聚合不同路径上的可用带

宽，以获得更高的网络带宽

提升传输的可靠性

• 使用多条路径传输数据，可以有效避免

因单条路径性能恶化或中断导致的应用

连接中断

支持链路的平滑切换

• 多路径传输方式允许终端在不同接入网

络间快速、平滑地切换，选取当前链路

质量最好的路径传输数据

##### MPTCP在网络体系结构中的位置

MPTCP位于套接字和TCP之间

<img src="../images/image-20241205103137769.png" alt="image-20241205103137769" style="zoom:50%;" />



公平性是关注的重点，MPTCP采用的是网络公平性原则



#### QUIC

##### TCP存在的问题

- TCP 实现在操作系统内核中
  - 作为传输优化的最终受益者，应用*无法对TCP进行修改*
  - 操作系统的更新往往跟不上应用的需求和节奏

- TCP体系握手时延大
  - 互联网上的大趋势：*低时延需求*越来越强烈；加密流量占比越来越大
  - TLS(传输层安全性协议)+TCP的体系握手时延很大，传输前需要3个RTT进行握手

TCP多流复用存在队头阻塞问题->多流复用

TCP传输需要保持有序性：出现丢包时，后面的数据需要等丢失的包重传完成才能使用，这就导致了队头阻塞

##### QUIC在网络体系结构中的位置

<img src="../images/image-20241205103839331.png" alt="image-20241205103839331" style="zoom:50%;" />

QUIC替代TCP、TLS和部分HTTP的功能



## 应用层

> [!IMPORTANT]
>
> 1. 掌握应用进程通信方式以及服务进程工作模式
> 2. 掌握域名系统基本原理和工作机制
> 3. 掌握电子邮件系统体系结构及基本工作原理
> 4. 了解WWW系统结构框架、静态和动态Web及其应用技术，掌握HTTP协议及其工作原理
>
> 5. 了解流媒体基本概念、数字音视频与编码、流式存储媒体、直播与实时音视频、流媒体动态自适应传输
>
> 6. 了解内容分发背景及内容分发网络、以及P2P网络的工作机制
> 7. 掌握Telnet、FTP、SNMP等应用层协议的工作原理

### 应用层概述

#### 应用进程通信方式

**客户/服务器**（**C/S**, Client/Server）方式

- 面向连接时，C/S通信关系一旦建立，通信就是双向的，双方地位平等，都可发送和接收数据

**浏览器/服务器**（**B/S**，Browser/Server） 方式

- 浏览器请求、服务器响应的工作模式；用户界面完全通过Web浏览器实现，一部分事务逻辑在前端实现，但主要的事务逻辑在服务器端实现
- 特点：
  - 界面统一，使用简单。客户端只需要安装浏览器软件
  - 易于维护。对应用系统升级时，只需更新服务器端的软件，减轻了系统维护和升级的成本
  - 可扩展性好。采用标准的TCP/IP和HTTP协议，具有良好的扩展性
  - 信息共享度高。HTML是数据格式的一个开放标准，目前大多数流行的软件均支持HTML

**对等**（**P2P**，Peer to Peer）方式

- 两个进程在通信时并*不区分*服务的请求方和服务的提供方
- 每一个P2P进程既是客户同时也是服务器

#### 服务器进程工作方式

**循环方式(iterative mode)**

• 一次只运行一个服务进程

• 当有多个客户进程请求服务时，服务进程就按请求的先后顺序依次做出响应 (阻塞方式) 

 **并发方式(concurrent mode)**

• 可以同时运行多个服务进程

• 每一个服务进程都对某个特定的客户进程做出响应 (非阻塞方式)



### 域名系统

#### 历史和概述

**域名系统（DNS，Domain Name System）**是互联网重要的基础设施之一，向所有需要域名解析的应用提供服务，主要负责将可读性好的域名映射成IP地址



#### 域名系统名字空间和层次结构

<img src="../images/image-20241205105348705.png" alt="image-20241205105348705" style="zoom: 50%;" />

edu可以时顶级域名也可以是二级域名，美国的大学的edu就是顶级域名

##### 域名系统名字空间和层次结构

<img src="../images/image-20241205105622639.png" alt="image-20241205105622639" style="zoom:50%;" />



#### 域名服务器

保存关于域树(domain tree)的结构和设置信息的服务器程序称为**名字服务器(name server)或域名服务器**，负责域名解析工作

域名解析过程对用户透明



名字服务器的管辖范围以“区”为单位，而不是以“域”为单位

 管辖区是域名“域”的子集。管辖区可以小于或等于域，但不可能大于域

##### 域名服务器分类

总体上，域名系统的名字服务器分为两大类

• **权威名字服务器(authoritative name server)**

• 一种根据本地知识知道一个DNS区(zone)的内容的服务器，它可以回答

有关该DNS区的查询而无需查询其他服务器

• 每个DNS区至少应有一个IPv4可访问的权威名字服务器提供服务

• **递归解析器(recursive resolver)/递归服务器**

• 以递归方式运行的、使用户程序联系域(domain)名字服务器的程序。

##### 权威名字服务器

根据对应域的层次，权威名字服务器又进一步分为以下类别

- 根名字服务器(root name server) /根服务器(root server)：
  - 每个根服务器都知道所有的顶级域名服务器的域名及其IP地址
  - 根服务器并不直接把主机用户所查的域名转换成IP地址
  - 根服务器共有13套，每套都可以有多个镜像(mirrored)根服务器，其内容定期与上述对应的根服务器同步

• 顶级域名字服务器(TLD name server)

- 二级域名字服务器(second level domain name server)
  - 一般来说，每个名字服务器只负责解析本辖域的域名

• 三级域名字服务器(third level domain name server)

- 三级域及以下的名字服务器也统称为本地域名服务器

##### 递归解析器/递归服务器

每一个Internet服务提供者**ISP(Internet Service Provider)**, 都至少有一个递归服务器，距离用户主机较近

在递归服务器/本地域名服务器有多层的结构中，当本层服务器没有解析结果时，通常是逐级向上递归进行查询

当查询请求到达本地域最上一层名字服务器时，该层服务器对自己无法解析的任何一个域名，首先求助于根服务器（而不是二级域名字服务器），开始逐步迭代查询



#### 域名解析过程

当某一应用进程需要进行域名解析时，该应用进程将域名放在DNS请求报文（<span style="color:#CC0000;">UDP数据报, 端口号为53</span>）发给递归服务器（使用UDP是为了减少开销）。递归服务器得到查询结果后, 将对应IP地址放在应答报文中返回给应用进程

域名查询有**递归查询(recursive query)**和**迭代查询(或循环查询，iterative query)**两种方式

- 主机向递归解析器/本地域名字服务器的查询一般采用*递归查询*
- 递归解析器/本地域名字服务器向根服务器可以采用递归查询，但一般优先采用*迭代查询*

<img src="../images/image-20241205112956349.png" alt="image-20241205112956349" style="zoom:33%;" /><img src="../images/image-20241205113024376.png" alt="image-20241205113024376" style="zoom:33%;" />

#### 域名系统查询和响应(选讲)

<img src="../images/image-20241205113339272.png" alt="image-20241205113339272" style="zoom:50%;" />

<img src="../images/image-20241205113535556.png" alt="image-20241205113535556" style="zoom:50%;" />

**资源记录部分**是DNS报文格式的最后3个字段，只有在DNS响应报文中才出现 ，包括 回答问题区域字段、权威名字服务器区域字段、附加信息区域字段。这3个字段都采用资源记录的格式

RR格式：(name, ttl, class, type, value)

##### DNSSEC

DNSSEC依靠数字签名保证DNS应答报文的真实性和完整性

#### 域名系统高速缓存

**DNS高速缓存作用**：为提高DNS查询效率，并减轻根域名服务器的负荷和减少Internet上的DNS查询报文数量，域名服务器广泛使用高速缓存，用来存放最近查询过的域名以及从何处获得域名映射信息的记录

好处：可以大大减轻根域名服务器的负荷，而且也能够使Internet上的DNS查询请求和回答报文的数量大为减少

#### 域名系统隐私(选讲)

QNAME是用户请求的域名全名，它提供了用户的操作信息

DNS敏感数据主要的泄露途径：通信链路窃听，服务器收集

> 思考题：What happens from opening a URL in a browser to the website being displayed?
>
> https://chatgpt.com/share/675122ac-d0a8-8002-9b88-0c990dcfe05f



### 电子邮件

#### 电子邮件系统体系结构

电子邮件系统采用客户/服务器（C/S）工作模式

- 用户代理（user agent）——邮件客户端
  - 无统一标准

- 传输代理（message transfer agent）——邮件服务器

- 简单邮件传输协议SMTP（Simple Mail Transfer Protocol）——邮件服务器之间传递邮件使用的协议
  - SMTP利用TCP可靠地从客户向服务器传递邮件，使用端口25
  - SMTP的3个阶段：连接建立、邮件传送、连接关闭
  - SMTP是一个简单的ASCII协议，邮件必须为7位ASCII
  - 不包括认证，不能传二进制数据（只能ASCII），邮件以明文形式出现

#### 邮件格式

RFC 5322—Internet邮件格式

• 基本ASCII电子邮件使用RFC 5322

• 最新修订的Internet邮件格式，其前身是RFC 822

 MIME(Multipurpose Internet Mail Extensions)—多用途Internet邮件扩展

• 基本格式的多媒体扩展

• 可传输多媒体消息和二进制文件

#### 最终交付协议

##### POP3协议

POP3由RFC1939定义，是一个非常简单的最终交付协议

POP3使用客户/服务器工作方式，在接收邮件的用户PC机中必须运行POP客户程序，

而在用户所连接的ISP的邮件服务器中则运行POP服务器程序

##### IMAP

- 用于最终交付的主要协议

- IMAP是较早使用的最终交付协议—POP3(邮局协议，版本3)的改进版

- 邮件服务器运行侦听端口143的IMAP服务器

  

### WWW

#### WWW体系结构概述

WWW=World Wide Web=万维网

WWW性能提升方法

缓存（caching），如代理技术

多线程（multiple threads）

前端（front end）

#### 静态Web（对象）

<img src="../images/image-20241205122218678.png" alt="image-20241205122218678" style="zoom:50%;" />

HTML和XML



#### 动态Web和Web应用



#### HTTP协议



#### Web缓存技术与Web代理



#### Web安全与隐私



### 流式音频和视频



### 内容分发



### 其它应用层协议



## PPT例题

1.<img src="../images/image-20240912113647866.png" alt="image-20240912113647866" style="zoom:50%;" />

> D

2. 
2. 
